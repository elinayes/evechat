<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CFA åˆ·é¢˜ç³»ç»Ÿ</title>
    <style>
        :root {
            --bg-color: #f5f0ed;
            --card-bg: #ffffff;
            --primary-color: #b8a9a0;
            --primary-hover: #a89589;
            --text-main: #5d5652;
            --text-light: #8a817c;
            --border-color: #e2d9d5;
            --accent-bg: #faf7f5;
            --correct-color: #9aae9e;
            --wrong-color: #c9a5a5;
            --tag-bg: #e8e2de;
            --sage-green: #a8b5a0;
            --dusty-rose: #c9b3b3;
            --slate-blue: #9aa8b5;
            --warm-taupe: #bab0a8;
            --muted-gold: #c4b896;
            --star-color: #d4b896;
            /* CFA æœºè€ƒé£æ ¼é¢œè‰² */
            --cfa-primary: #1a365d;
            --cfa-primary-hover: #2c5282;
            --cfa-secondary: #4a5568;
            --cfa-secondary-hover: #718096;
            --cfa-accent: #3182ce;
            --cfa-warning: #dd6b20;
            --cfa-success: #38a169;
        }

        [data-theme="dark"] {
            --bg-color: #2a2725;
            --card-bg: #363230;
            --primary-color: #a89080;
            --primary-hover: #b9a090;
            --text-main: #d5d0cc;
            --text-light: #9a9590;
            --border-color: #4a4542;
            --accent-bg: #3a3533;
            --correct-color: #8a9e8d;
            --wrong-color: #b89090;
            --tag-bg: #454038;
            --star-color: #c4a880;
            --cfa-primary: #2c5282;
            --cfa-primary-hover: #3182ce;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            padding: 15px;
            transition: background-color 0.3s, color 0.3s;
        }

        .container { 
            background: var(--card-bg); 
            padding: 35px; 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(139, 125, 115, 0.12); 
            width: 100%;
            max-width: 1200px;
            min-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.3s;
        }

        .scroll-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 8px;
            padding-bottom: 15px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary-color); }

        h1, h2, h3 { 
            text-align: center; 
            color: var(--text-main); 
            font-weight: 500; 
            margin-top: 0;
            letter-spacing: 0.5px;
        }

        h1 { font-size: 1.8em; }
        h2 { font-size: 1.4em; }
        h3 { font-size: 1.1em; }

        input[type="text"], input[type="password"], textarea { 
            width: 100%; 
            padding: 14px 16px; 
            border: 1.5px solid var(--border-color); 
            border-radius: 10px; 
            font-family: inherit; 
            resize: none; 
            background: var(--accent-bg); 
            outline: none;
            color: var(--text-main);
            font-size: 15px;
            transition: border-color 0.2s, background-color 0.3s;
        }
        input[type="text"]:focus, input[type="password"]:focus, textarea:focus { border-color: var(--primary-color); }
        textarea { height: 180px; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; }

        select {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 10px;
            background: var(--accent-bg);
            color: var(--text-main);
            font-size: 15px;
            cursor: pointer;
            outline: none;
        }
        select:focus { border-color: var(--primary-color); }

        /* CFA æœºè€ƒé£æ ¼æŒ‰é’® */
        button { 
            display: inline-block; 
            padding: 12px 24px; 
            background-color: var(--cfa-primary); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: all 0.2s ease; 
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover { 
            background-color: var(--cfa-primary-hover); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        button.secondary { 
            background-color: var(--cfa-secondary); 
            color: white; 
        }
        button.secondary:hover { background-color: var(--cfa-secondary-hover); }
        
        button.danger { 
            background-color: #c53030; 
            color: white; 
        }
        button.danger:hover { background-color: #e53e3e; }

        button.success {
            background-color: var(--cfa-success);
            color: white;
        }
        button.success:hover { background-color: #48bb78; }

        button.warning {
            background-color: var(--cfa-warning);
            color: white;
        }
        button.warning:hover { background-color: #ed8936; }

        button.accent {
            background-color: var(--cfa-accent);
            color: white;
        }
        button.accent:hover { background-color: #4299e1; }

        button.small { padding: 8px 16px; font-size: 12px; }
        button.tiny { padding: 6px 12px; font-size: 11px; text-transform: none; }

        /* æœºè€ƒé£æ ¼çš„ç‰¹æ®ŠæŒ‰é’® */
        button.cfa-nav {
            background: linear-gradient(180deg, #4a5568 0%, #2d3748 100%);
            border: 1px solid #1a202c;
            padding: 10px 20px;
        }
        button.cfa-nav:hover {
            background: linear-gradient(180deg, #718096 0%, #4a5568 100%);
        }

        button.cfa-submit {
            background: linear-gradient(180deg, #38a169 0%, #276749 100%);
            border: 1px solid #22543d;
            padding: 12px 30px;
            font-size: 15px;
        }
        button.cfa-submit:hover {
            background: linear-gradient(180deg, #48bb78 0%, #38a169 100%);
        }

        button.cfa-next {
            background: linear-gradient(180deg, #3182ce 0%, #2c5282 100%);
            border: 1px solid #1a365d;
            padding: 12px 30px;
            font-size: 15px;
        }
        button.cfa-next:hover {
            background: linear-gradient(180deg, #4299e1 0%, #3182ce 100%);
        }

        button.cfa-exit {
            background: linear-gradient(180deg, #718096 0%, #4a5568 100%);
            border: 1px solid #2d3748;
        }
        button.cfa-exit:hover {
            background: linear-gradient(180deg, #a0aec0 0%, #718096 100%);
        }

        button.cfa-tool {
            background: linear-gradient(180deg, #805ad5 0%, #553c9a 100%);
            border: 1px solid #44337a;
            padding: 10px 16px;
        }
        button.cfa-tool:hover {
            background: linear-gradient(180deg, #9f7aea 0%, #805ad5 100%);
        }

        .hidden { display: none !important; }
        .center-box { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
        }

        .top-toolbar {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--accent-bg);
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: var(--text-light);
            transition: all 0.2s;
            padding: 0;
            text-transform: none;
            box-shadow: none;
        }
        .icon-btn:hover {
            background: var(--tag-bg);
            color: var(--text-main);
        }
        .icon-btn.synced {
            color: var(--correct-color);
            border-color: var(--correct-color);
        }
        .icon-btn.syncing {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .sync-status {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
        }

        .sync-dot.connected { background: var(--correct-color); }
        .sync-dot.syncing { background: var(--muted-gold); animation: pulse 1s infinite; }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1.5px solid var(--border-color);
            margin-bottom: 20px;
            flex-shrink: 0;
            gap: 15px;
        }

        .nav-bar h2, .nav-bar h3 { margin: 0; }

        .main-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            border-bottom: 1.5px solid var(--border-color);
            padding-bottom: 15px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 24px;
            background: var(--accent-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.2s;
            text-transform: none;
            box-shadow: none;
        }

        .tab-btn:hover {
            background: var(--tag-bg);
            color: var(--text-main);
        }

        .tab-btn.active {
            background: var(--cfa-primary);
            color: white;
            border-color: var(--cfa-primary);
        }

        .tag-section { margin-bottom: 20px; }

        .tag-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .tag-header span { font-size: 13px; color: var(--text-light); }

        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; }

        .tag {
            padding: 5px 12px;
            background: var(--tag-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            font-size: 12px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag:hover { background: var(--border-color); }
        .tag.active { background: var(--cfa-primary); color: white; border-color: var(--cfa-primary); }

        .tag.tag-npv { border-left: 3px solid var(--sage-green); }
        .tag.tag-capm { border-left: 3px solid var(--slate-blue); }
        .tag.tag-bond { border-left: 3px solid var(--warm-taupe); }
        .tag.tag-derivative { border-left: 3px solid var(--muted-gold); }
        .tag.tag-ethics { border-left: 3px solid #a8c4a8; }
        .tag.tag-fsa { border-left: 3px solid #b5a8c4; }
        .tag.tag-portfolio { border-left: 3px solid #c4b0a8; }
        .tag.tag-equity { border-left: 3px solid #a8b8c4; }

        .question-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .question-tag { padding: 3px 8px; background: var(--accent-bg); border-radius: 10px; font-size: 11px; color: var(--text-light); }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 18px;
            padding: 5px;
        }

        .book-card {
            background: var(--accent-bg);
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.25s;
            position: relative;
            min-height: 150px;
        }
        .book-card:hover {
            border-color: var(--cfa-primary);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(139, 125, 115, 0.15);
        }
        .book-card.quiz-bank { border-left: 4px solid var(--sage-green); }
        
        .book-title { font-size: 1.1em; font-weight: 600; margin-bottom: 8px; color: var(--text-main); }
        .book-stats { font-size: 0.88em; color: var(--text-light); margin-bottom: 15px; line-height: 1.6; }
        .book-actions { display: flex; justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }
        
        .empty-state { text-align: center; color: var(--text-light); margin-top: 60px; line-height: 1.8; }

        .option-label { 
            display: flex; 
            align-items: flex-start; 
            padding: 16px 20px; 
            border: 1.5px solid var(--border-color); 
            border-radius: 10px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            transition: all 0.2s; 
            background: var(--card-bg);
            line-height: 1.5;
        }
        .option-label:hover { border-color: var(--cfa-primary); background-color: var(--accent-bg); }
        .option-label.selected { border-color: var(--cfa-primary); background-color: var(--accent-bg); font-weight: 500; }
        input[type="radio"] { accent-color: var(--cfa-primary); margin-right: 14px; margin-top: 3px; transform: scale(1.15); flex-shrink: 0; }

        .review-item {
            border: 1px solid var(--border-color); 
            border-radius: 10px;
            padding: 20px; 
            margin-bottom: 15px; 
            background: var(--card-bg);
            position: relative;
        }
        .review-item.starred { border-color: var(--star-color); background: linear-gradient(135deg, var(--card-bg) 0%, rgba(212, 184, 150, 0.08) 100%); }

        .dashboard-modes { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 18px; 
            margin-top: 25px;
            width: 100%;
            max-width: 500px;
        }
        .mode-card {
            background: var(--accent-bg); 
            border: 1.5px solid var(--border-color);
            border-radius: 12px; 
            padding: 25px; 
            text-align: center; 
            cursor: pointer;
            transition: all 0.25s;
        }
        .mode-card:hover { border-color: var(--cfa-primary); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(139, 125, 115, 0.12); }
        .mode-card h3 { margin-bottom: 8px; }
        .mode-card p { font-size: 0.88em; margin: 0; color: var(--text-light); line-height: 1.5; }

        .feedback-box { margin-top: 20px; padding: 18px; border-radius: 10px; display: none; text-align: center; line-height: 1.6; }
        .feedback-correct { background-color: #eef3ef; color: #5a6b5d; }
        .feedback-wrong { background-color: #f5eeee; color: #7a6262; }
        [data-theme="dark"] .feedback-correct { background-color: #3a4038; color: #a0b0a0; }
        [data-theme="dark"] .feedback-wrong { background-color: #453838; color: #c0a0a0; }

        .badge { padding: 8px 16px; background: var(--accent-bg); color: var(--text-light); border-radius: 6px; font-weight: 500; }

        #question-text { font-size: 1.2em; line-height: 1.7; margin-bottom: 15px; text-align: left; color: var(--text-main); }

        .timer { font-family: 'Consolas', monospace; font-size: 1.1em; color: var(--text-light); padding: 8px 16px; background: var(--accent-bg); border-radius: 6px; }

        .progress-bar-container { width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--cfa-primary); border-radius: 3px; transition: width 0.3s ease; }

        .result-section { text-align: center; padding: 30px 0; }
        .result-score { font-size: 3em; font-weight: 300; color: var(--text-main); margin-bottom: 10px; }
        .result-label { font-size: 1.1em; color: var(--text-light); margin-bottom: 30px; }

        .stat-number { font-size: 2.2em; font-weight: 300; }
        .stat-number.wrong { color: var(--wrong-color); }
        .stat-number.correct { color: var(--correct-color); }
        .stat-label { font-size: 0.85em; color: var(--text-light); margin-top: 5px; }

        .btn-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        .search-box input { flex: 1; }

        .filter-info { padding: 10px 15px; background: var(--accent-bg); border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--text-light); }

        .star-btn { position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; border: none; background: transparent; cursor: pointer; font-size: 18px; color: var(--border-color); transition: all 0.2s; padding: 0; box-shadow: none; }
        .star-btn:hover { color: var(--star-color); transform: scale(1.1); background: transparent; }
        .star-btn.starred { color: var(--star-color); }

        .error-badge { display: inline-block; padding: 2px 8px; background: var(--wrong-color); color: white; border-radius: 10px; font-size: 11px; margin-left: 8px; }

        .note-section { margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border-color); }
        .note-input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; background: var(--accent-bg); color: var(--text-main); resize: none; height: 60px; }
        .note-display { font-size: 13px; color: var(--text-light); font-style: italic; padding: 8px 12px; background: var(--accent-bg); border-radius: 6px; line-height: 1.5; white-space: pre-wrap; }

        .stats-panel { background: var(--accent-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px; }
        .stat-card { text-align: center; padding: 15px; background: var(--card-bg); border-radius: 8px; }
        .stat-card .value { font-size: 1.8em; font-weight: 300; color: var(--text-main); }
        .stat-card .label { font-size: 12px; color: var(--text-light); margin-top: 5px; }

        .tag-stats { margin-top: 15px; }
        .tag-stat-row { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .tag-stat-row:last-child { border-bottom: none; }
        .tag-stat-name { flex: 1; font-size: 13px; }
        .tag-stat-bar { width: 100px; height: 6px; background: var(--border-color); border-radius: 3px; margin: 0 15px; overflow: hidden; }
        .tag-stat-fill { height: 100%; background: var(--wrong-color); border-radius: 3px; }
        .tag-stat-count { font-size: 12px; color: var(--text-light); width: 50px; text-align: right; }

        .checkbox-row { display: flex; align-items: center; gap: 10px; margin: 15px 0; }
        .checkbox-row input[type="checkbox"] { accent-color: var(--cfa-primary); transform: scale(1.2); }
        .checkbox-row label { font-size: 14px; color: var(--text-main); cursor: pointer; }

        .settings-section { background: var(--accent-bg); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .settings-section h3 { text-align: left; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 13px; color: var(--text-light); margin-bottom: 6px; }
        .input-with-btn { display: flex; gap: 10px; }
        .input-with-btn input { flex: 1; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background: var(--text-main); color: var(--card-bg); border-radius: 8px; font-size: 14px; z-index: 1000; animation: toastIn 0.3s ease; }
        .toast.success { background: var(--correct-color); color: white; }
        .toast.error { background: var(--wrong-color); color: white; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        .merge-checkbox { position: absolute; top: 15px; left: 15px; }
        .merge-checkbox input { accent-color: var(--cfa-primary); transform: scale(1.3); }

        .backup-info { font-size: 12px; color: var(--text-light); text-align: center; margin-top: 10px; }

        .section-divider { border-top: 2px solid var(--border-color); margin: 30px 0 20px 0; padding-top: 20px; }
        .section-title { font-size: 14px; color: var(--text-light); margin-bottom: 15px; font-weight: 500; }

        .quiz-source-selector { margin-bottom: 25px; padding: 20px; background: var(--accent-bg); border-radius: 12px; }
        .quiz-source-selector h3 { text-align: left; margin-bottom: 15px; }

        /* ========== AI åŠ©æ‰‹å¼¹çª—æ ·å¼ ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
            text-align: left;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-bg);
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: none;
        }
        .modal-close:hover {
            background: var(--border-color);
            color: var(--text-main);
        }
        .modal-body {
            padding: 20px 25px;
            overflow-y: auto;
            flex: 1;
        }

        /* AI èŠå¤©åŒºåŸŸ */
        .ai-chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 400px;
        }
        .ai-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--accent-bg);
            border-radius: 10px;
            min-height: 200px;
            max-height: 300px;
        }
        .ai-message {
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 14px;
        }
        .ai-message.user {
            background: var(--cfa-primary);
            color: white;
            margin-left: 40px;
            border-bottom-right-radius: 4px;
        }
        .ai-message.assistant {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            margin-right: 40px;
            border-bottom-left-radius: 4px;
        }
        .ai-message.system {
            background: var(--tag-bg);
            color: var(--text-light);
            font-size: 12px;
            text-align: center;
            margin: 10px 60px;
        }
        .ai-message-label {
            font-size: 11px;
            color: var(--text-light);
            margin-bottom: 4px;
            font-weight: 600;
        }
        .ai-message.user .ai-message-label {
            color: rgba(255,255,255,0.7);
        }
        .ai-input-area {
            display: flex;
            gap: 10px;
        }
        .ai-input-area textarea {
            flex: 1;
            height: 80px;
            font-family: inherit;
            font-size: 14px;
        }
        .ai-input-area button {
            align-self: flex-end;
        }
        .ai-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-light);
            font-size: 13px;
            padding: 10px;
        }
        .ai-loading-dots {
            display: flex;
            gap: 4px;
        }
        .ai-loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--cfa-primary);
            border-radius: 50%;
            animation: dotPulse 1.4s infinite ease-in-out both;
        }
        .ai-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .ai-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes dotPulse {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* ç¬”è®°å¼¹çª—æ ·å¼ */
        .note-modal-textarea {
            width: 100%;
            height: 200px;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .note-hint {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 15px;
            padding: 10px;
            background: var(--accent-bg);
            border-radius: 8px;
            line-height: 1.5;
        }

        /* åšé¢˜ç•Œé¢å·¥å…·æ  */
        .quiz-toolbar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
            flex-wrap: wrap;
        }

        /* é€‰ä¸­æ–‡æœ¬æ·»åŠ åˆ°ç¬”è®° */
        .selection-tooltip {
            position: fixed;
            background: var(--cfa-primary);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
        }
        .selection-tooltip:hover {
            background: var(--cfa-primary-hover);
        }

        @media (max-width: 600px) {
            .container { padding: 20px; }
            .dashboard-modes { grid-template-columns: 1fr; }
            .main-tabs { flex-wrap: wrap; }
            .nav-bar { flex-wrap: wrap; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .top-toolbar { top: 10px; right: 10px; }
            .sync-status { display: none; }
            .modal-content { width: 95%; max-height: 90vh; }
            .ai-message.user { margin-left: 20px; }
            .ai-message.assistant { margin-right: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    
    <div class="sync-status">
        <span class="sync-dot" id="sync-dot"></span>
        <span id="sync-text">æœ¬åœ°æ¨¡å¼</span>
    </div>

    <div class="top-toolbar">
        <button class="icon-btn" id="sync-btn" onclick="manualSync()" title="åŒæ­¥æ•°æ®">S</button>
        <button class="icon-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
            <span id="theme-icon">D</span>
        </button>
    </div>

    <!-- ä¸»é¡µé¢ -->
    <div id="view-main" style="display: flex; flex-direction: column; height: 100%;">
        <div class="main-tabs">
            <div class="tab-btn active" onclick="switchMainTab('quiz')">åˆ·é¢˜</div>
            <div class="tab-btn" onclick="switchMainTab('banks')">é¢˜åº“</div>
            <div class="tab-btn" onclick="switchMainTab('library')">é”™é¢˜æœ¬</div>
            <div class="tab-btn" onclick="switchMainTab('stats')">ç»Ÿè®¡</div>
            <div class="tab-btn" onclick="switchMainTab('settings')">è®¾ç½®</div>
        </div>

        <!-- åˆ·é¢˜æ¨¡å¼ -->
        <div id="tab-quiz" class="scroll-content">
            <div style="max-width: 600px; margin: 0 auto;">
                <h2>å¼€å§‹åˆ·é¢˜</h2>
                
                <!-- ä»é¢˜åº“é€‰æ‹© -->
                <div class="quiz-source-selector">
                    <h3>ä»å·²ä¿å­˜é¢˜åº“é€‰æ‹©</h3>
                    <select id="quiz-bank-select">
                        <option value="">-- é€‰æ‹©é¢˜åº“ --</option>
                    </select>
                    <div style="margin-top: 15px; text-align: center;">
                        <button onclick="startQuizFromBank()">å¼€å§‹åˆ·é¢˜</button>
                    </div>
                </div>

                <div class="section-divider">
                    <div class="section-title">æˆ–è€…ç›´æ¥ç²˜è´´ JSON</div>
                </div>

                <textarea id="quiz-json-input" placeholder='[{"question": "...", "options": [...], "answer": "..."}]'></textarea>
                
                <div class="checkbox-row">
                    <input type="checkbox" id="shuffle-checkbox" checked>
                    <label for="shuffle-checkbox">éšæœºæ‰“ä¹±é¢˜ç›®é¡ºåº</label>
                </div>
                <div class="checkbox-row">
                    <input type="checkbox" id="timer-checkbox" checked>
                    <label for="timer-checkbox">æ˜¾ç¤ºè®¡æ—¶å™¨</label>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="startQuiz()">å¼€å§‹åˆ·é¢˜</button>
                </div>
                <p id="quiz-error" style="color: var(--wrong-color); margin-top: 15px; text-align: center;"></p>
            </div>
        </div>

        <!-- é¢˜åº“ç®¡ç† -->
        <div id="tab-banks" class="scroll-content hidden">
            <div class="nav-bar" style="border-bottom: none; margin-bottom: 15px; padding-bottom: 0;">
                <span style="color: var(--text-light); font-size: 14px;">å…± <span id="total-banks">0</span> å¥—é¢˜åº“</span>
                <button onclick="showAddBankView()">æ·»åŠ é¢˜åº“</button>
            </div>
            <div id="banks-container"></div>
        </div>

        <!-- é”™é¢˜æœ¬ -->
        <div id="tab-library" class="scroll-content hidden">
            <div class="nav-bar" style="border-bottom: none; margin-bottom: 15px; padding-bottom: 0;">
                <span style="color: var(--text-light); font-size: 14px;">å…± <span id="total-books">0</span> æœ¬é”™é¢˜æœ¬</span>
                <div class="btn-group">
                    <button class="small secondary" id="merge-btn" onclick="toggleMergeMode()">åˆå¹¶æ¨¡å¼</button>
                    <button onclick="showImportView()">æ–°å»ºé”™é¢˜æœ¬</button>
                </div>
            </div>

            <div class="search-box">
                <input type="text" id="search-input" placeholder="æœç´¢é¢˜ç›®å†…å®¹..." oninput="handleSearch()">
                <button class="secondary" onclick="clearSearch()">æ¸…é™¤</button>
            </div>

            <div class="tag-section" id="library-tag-section">
                <div class="tag-header">
                    <span>æŒ‰æ ‡ç­¾ç­›é€‰</span>
                    <button class="small secondary" onclick="clearTagFilter()">æ¸…é™¤ç­›é€‰</button>
                </div>
                <div class="tag-container" id="library-tags"></div>
            </div>

            <div id="filter-info" class="filter-info hidden">
                <span id="filter-text">ç­›é€‰ç»“æœ</span>
                <button class="small secondary" onclick="clearAllFilters()">æ¸…é™¤</button>
            </div>

            <div id="merge-toolbar" class="hidden" style="margin-bottom: 15px; padding: 15px; background: var(--accent-bg); border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>å·²é€‰æ‹© <strong id="merge-count">0</strong> ä¸ªé”™é¢˜æœ¬</span>
                    <div class="btn-group">
                        <button class="small" onclick="executeMerge()">åˆå¹¶é€‰ä¸­</button>
                        <button class="small secondary" onclick="cancelMerge()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div id="library-container"></div>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div id="tab-stats" class="scroll-content hidden">
            <h2>å­¦ä¹ ç»Ÿè®¡</h2>
            
            <div class="stats-panel">
                <h3 style="margin-bottom: 0;">æ€»è§ˆ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="stat-total-banks">0</div>
                        <div class="label">é¢˜åº“</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-total-mistakes">0</div>
                        <div class="label">å¾…æ”»å…‹</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-total-solved">0</div>
                        <div class="label">å·²æ–©æ€</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="stat-total-starred">0</div>
                        <div class="label">å·²æ”¶è—</div>
                    </div>
                </div>
            </div>

            <div class="stats-panel">
                <h3 style="margin-bottom: 0;">æ ‡ç­¾åˆ†å¸ƒ</h3>
                <div class="tag-stats" id="tag-stats-container"></div>
            </div>

            <div class="stats-panel">
                <h3 style="margin-bottom: 0;">é«˜é¢‘é”™é¢˜</h3>
                <p style="color: var(--text-light); font-size: 13px; margin-bottom: 15px;">é”™è¯¯æ¬¡æ•°æœ€å¤šçš„é¢˜ç›®</p>
                <div id="frequent-mistakes-container"></div>
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div id="tab-settings" class="scroll-content hidden">
            <h2>è®¾ç½®</h2>

            <!-- AI åŠ©æ‰‹è®¾ç½® -->
            <div class="settings-section">
                <h3>ğŸ¤– AI åŠ©æ‰‹é…ç½®</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 20px; line-height: 1.6;">
                    é…ç½® AI API åï¼Œå¯åœ¨åšé¢˜æ—¶ä½¿ç”¨ AI åŠ©æ‰‹å¸®åŠ©ç†è§£é¢˜ç›®ã€‚æ”¯æŒ OpenAI å…¼å®¹æ¥å£ï¼ˆå¦‚ SiliconFlowã€DeepSeek ç­‰ï¼‰ã€‚
                </p>
                
                <div class="input-group">
                    <label>API Base URL</label>
                    <input type="text" id="ai-api-url" placeholder="ä¾‹å¦‚: https://api.siliconflow.cn/v1">
                </div>

                <div class="input-group">
                    <label>API Key</label>
                    <div class="input-with-btn">
                        <input type="password" id="ai-api-key" placeholder="sk-xxxxxxxxxxxx">
                        <button class="small secondary" onclick="toggleAIKeyVisibility()">æ˜¾ç¤º</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>æ¨¡å‹åç§°</label>
                    <div class="input-with-btn">
                        <input type="text" id="ai-model" placeholder="ä¾‹å¦‚: deepseek-ai/DeepSeek-V3">
                        <button class="small secondary" onclick="fetchAIModels()">æ‹‰å–æ¨¡å‹</button>
                    </div>
                    <select id="ai-model-select" style="margin-top: 8px; display: none;">
                        <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>é»˜è®¤æç¤ºè¯ï¼ˆå¯è‡ªå®šä¹‰ï¼‰</label>
                    <textarea id="ai-system-prompt" style="height: 100px; font-family: inherit;">æˆ‘æ˜¯ä¸€å CFA å¤‡è€ƒè€ƒç”Ÿï¼Œæ­£åœ¨åˆ·é¢˜ç»ƒä¹ ã€‚è¯·å¸®æˆ‘åˆ†æä»¥ä¸‹é¢˜ç›®ï¼Œç”¨ä¸­æ–‡å›ç­”ï¼Œè§£é‡Šæ¸…æ¥šæ¯ä¸ªé€‰é¡¹ä¸ºä»€ä¹ˆå¯¹æˆ–é”™ï¼Œå¹¶è®²è§£ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚</textarea>
                </div>

                <div class="btn-group" style="justify-content: flex-start; margin-top: 20px;">
                    <button onclick="saveAIConfig()">ä¿å­˜ AI é…ç½®</button>
                    <button class="secondary" onclick="testAIConnection()">æµ‹è¯•è¿æ¥</button>
                </div>

                <div id="ai-config-status" class="backup-info"></div>
            </div>

            <div class="settings-section">
                <h3>äº‘åŒæ­¥ (GitHub Gist)</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 20px; line-height: 1.6;">
                    ä½¿ç”¨ GitHub Gist å­˜å‚¨æ•°æ®ï¼Œå®ç°å¤šè®¾å¤‡åŒæ­¥ã€‚é¢˜åº“å’Œé”™é¢˜æœ¬éƒ½ä¼šåŒæ­¥ã€‚
                </p>
                
                <div class="input-group">
                    <label>GitHub Personal Access Token</label>
                    <div class="input-with-btn">
                        <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
                        <button class="small secondary" onclick="toggleTokenVisibility()">æ˜¾ç¤º</button>
                    </div>
                    <p style="font-size: 12px; color: var(--text-light); margin-top: 6px;">
                        éœ€è¦ gist æƒé™ã€‚<a href="https://github.com/settings/tokens/new?scopes=gist&description=CFA%20Study%20Sync" target="_blank" style="color: var(--cfa-accent);">ç‚¹å‡»åˆ›å»º Token</a>
                    </p>
                </div>

                <div class="input-group">
                    <label>Gist ID (é¦–æ¬¡åŒæ­¥åè‡ªåŠ¨ç”Ÿæˆ)</label>
                    <input type="text" id="gist-id" placeholder="é¦–æ¬¡ä¸Šä¼ ä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œæˆ–è¾“å…¥å·²æœ‰ Gist ID">
                </div>

                <div class="btn-group" style="justify-content: flex-start; margin-top: 20px;">
                    <button onclick="saveCloudConfig()">ä¿å­˜é…ç½®</button>
                    <button class="secondary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                    <button class="success" onclick="uploadToCloud()">ä¸Šä¼ åˆ°äº‘ç«¯</button>
                    <button class="secondary" onclick="downloadFromCloud()">ä»äº‘ç«¯ä¸‹è½½</button>
                </div>

                <div id="cloud-status" class="backup-info"></div>
            </div>

            <div class="settings-section">
                <h3>æœ¬åœ°å¤‡ä»½</h3>
                <p style="font-size: 13px; color: var(--text-light); margin-bottom: 15px;">
                    å¯¼å‡º/å¯¼å…¥å®Œæ•´æ•°æ®æ–‡ä»¶ï¼ˆåŒ…å«é¢˜åº“å’Œé”™é¢˜æœ¬ï¼‰ã€‚
                </p>
                <div class="btn-group" style="justify-content: flex-start;">
                    <button class="secondary" onclick="exportAllData()">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
                    <button class="secondary" onclick="document.getElementById('import-file').click()">å¯¼å…¥æ•°æ®æ–‡ä»¶</button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importAllData(event)">
                </div>
            </div>

            <div class="settings-section">
                <h3>å±é™©æ“ä½œ</h3>
                <div class="btn-group" style="justify-content: flex-start;">
                    <button class="danger" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ é¢˜åº“é¡µé¢ -->
    <div id="view-add-bank" class="center-box hidden">
        <div style="width: 100%; max-width: 550px;">
            <h2>æ·»åŠ é¢˜åº“</h2>
            <p style="margin-bottom: 8px; color: var(--text-light);">é¢˜åº“åç§°</p>
            <input type="text" id="bank-name-input" placeholder="ä¾‹å¦‚ï¼šCFA L1 Ethics Chapter 1">
            
            <p style="margin-bottom: 8px; margin-top: 20px; color: var(--text-light);">ç²˜è´´é¢˜ç›® JSON æ•°æ®</p>
            <textarea id="bank-json-input" placeholder='[{"question": "...", "options": [...], "answer": "..."}]'></textarea>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveNewBank()" style="flex: 2;">ä¿å­˜é¢˜åº“</button>
                <button class="secondary" onclick="backToMain()" style="flex: 1;">å–æ¶ˆ</button>
            </div>
            <p id="bank-error" style="color: var(--wrong-color); margin-top: 12px; text-align: center;"></p>
        </div>
    </div>

    <!-- æ–°å»ºé”™é¢˜æœ¬é¡µé¢ -->
    <div id="view-import" class="center-box hidden">
        <div style="width: 100%; max-width: 550px;">
            <h2>æ–°å»ºé”™é¢˜æœ¬</h2>
            <p style="margin-bottom: 8px; color: var(--text-light);">é”™é¢˜æœ¬åç§°</p>
            <input type="text" id="set-name-input" placeholder="ä¾‹å¦‚ï¼šCFA L1 Ethics">
            
            <p style="margin-bottom: 8px; margin-top: 20px; color: var(--text-light);">ç²˜è´´é”™é¢˜ JSON æ•°æ®</p>
            <textarea id="import-json-input" placeholder='[{"question": "...", "options": [...], "answer": "..."}]'></textarea>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="saveNewBook()" style="flex: 2;">ä¿å­˜</button>
                <button class="secondary" onclick="backToMain()" style="flex: 1;">å–æ¶ˆ</button>
            </div>
            <p id="import-error" style="color: var(--wrong-color); margin-top: 12px; text-align: center;"></p>
        </div>
    </div>

    <!-- åˆ·é¢˜é¡µé¢ -->
    <div id="view-quiz" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="nav-bar">
            <button class="cfa-exit" onclick="confirmExitQuiz()">EXIT</button>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span class="badge" id="quiz-progress"></span>
                <span class="badge">å¾—åˆ†: <span id="quiz-score">0</span></span>
                <span class="timer" id="quiz-timer">00:00</span>
            </div>
        </div>
        
        <div class="progress-bar-container">
            <div class="progress-bar" id="quiz-progress-bar" style="width: 0%;"></div>
        </div>

        <div class="scroll-content" style="max-width: 800px; margin: 0 auto; width: 100%;">
            <div id="question-text"></div>
            <div id="question-tags-display" class="question-tags"></div>
            <div id="options-container" style="margin-top: 20px;"></div>
            <div id="quiz-feedback" class="feedback-box"></div>
            
            <!-- åšé¢˜æŒ‰é’®åŒºåŸŸ - CFAæœºè€ƒé£æ ¼ -->
            <div style="margin-top: 25px; text-align: center;">
                <button id="quiz-submit-btn" class="cfa-submit" onclick="checkQuizAnswer()">SUBMIT</button>
                <button id="quiz-next-btn" class="cfa-next hidden" onclick="nextQuizQuestion()">NEXT â†’</button>
            </div>

            <!-- å·¥å…·æ  - AIåŠ©æ‰‹å’Œç¬”è®° -->
            <div class="quiz-toolbar">
                <button class="cfa-tool tiny" onclick="openAIAssistant()">ğŸ¤– AI æ±‚åŠ©</button>
                <button class="tiny secondary" onclick="openNoteModal()">ğŸ“ æ·»åŠ ç¬”è®°</button>
                <button class="tiny secondary" id="quiz-flag-btn" onclick="toggleQuizFlag()">ğŸš© æ ‡è®°</button>
            </div>
        </div>
    </div>

    <!-- åˆ·é¢˜ç»“æœé¡µé¢ -->
    <div id="view-quiz-result" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="scroll-content">
            <div class="result-section">
                <h2>åˆ·é¢˜å®Œæˆ</h2>
                <div class="result-score"><span id="final-score">0</span> / <span id="final-total">0</span></div>
                <div class="result-label">
                    æ­£ç¡®ç‡: <span id="accuracy-rate">0</span>% | 
                    ç”¨æ—¶: <span id="total-time">00:00</span>
                </div>
                
                <div id="quiz-result-mistakes" class="hidden" style="margin-top: 30px; text-align: left;">
                    <h3 style="color: var(--wrong-color); text-align: center;">æœ¬æ¬¡é”™é¢˜</h3>
                    <p style="text-align: center; color: var(--text-light); font-size: 14px; margin-bottom: 15px;">
                        é”™é¢˜å·²è‡ªåŠ¨æ·»åŠ åˆ°é”™é¢˜æœ¬ï¼Œä¸‹æ–¹ JSON å¯å¤åˆ¶ç”¨äºè®²è§£
                    </p>
                    <textarea id="quiz-mistake-json" readonly style="height: 250px;"></textarea>
                    <div class="btn-group" style="margin-top: 15px;">
                        <button class="secondary" onclick="copyQuizMistakes()">å¤åˆ¶ JSON</button>
                    </div>
                </div>

                <div id="quiz-result-perfect" class="hidden" style="margin-top: 40px;">
                    <h3 style="color: var(--correct-color);">å…¨éƒ¨æ­£ç¡®</h3>
                    <p style="color: var(--text-light);">å¤ªæ£’äº†ï¼Œæ²¡æœ‰é”™é¢˜</p>
                </div>

                <div class="btn-group" style="margin-top: 30px;">
                    <button onclick="backToMain()">è¿”å›ä¸»é¡µ</button>
                    <button class="secondary" onclick="restartQuiz()">å†åšä¸€æ¬¡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é”™é¢˜æœ¬è¯¦æƒ…é¡µ -->
    <div id="view-book" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="nav-bar">
            <button class="secondary" onclick="backToMain()">è¿”å›</button>
            <h3 id="book-title-display" style="margin: 0;"></h3>
            <div style="width: 70px;"></div>
        </div>

        <div class="center-box" style="justify-content: flex-start; padding-top: 20px;">
            <div style="display: flex; gap: 40px; margin-bottom: 25px;">
                <div style="text-align: center;">
                    <div class="stat-number wrong" id="book-remaining">0</div>
                    <div class="stat-label">å¾…æ”»å…‹</div>
                </div>
                <div style="text-align: center;">
                    <div class="stat-number correct" id="book-solved">0</div>
                    <div class="stat-label">å·²æ–©æ€</div>
                </div>
                <div style="text-align: center;">
                    <div class="stat-number" style="color: var(--star-color);" id="book-starred">0</div>
                    <div class="stat-label">å·²æ”¶è—</div>
                </div>
            </div>

            <div class="tag-section" style="width: 100%; max-width: 500px;">
                <div class="tag-header"><span>é¢˜ç›®æ ‡ç­¾</span></div>
                <div class="tag-container" id="book-tags"></div>
            </div>

            <div class="dashboard-modes">
                <div class="mode-card" onclick="startRedo()">
                    <h3>é”™é¢˜é‡åš</h3>
                    <p>åšå¯¹è‡ªåŠ¨ç§»é™¤<br>åšé”™ç»§ç»­ä¿ç•™</p>
                </div>
                <div class="mode-card" onclick="startReview()">
                    <h3>é”™é¢˜å›é¡¾</h3>
                    <p>æµè§ˆæ¨¡å¼<br>æŸ¥çœ‹ç­”æ¡ˆ</p>
                </div>
                <div class="mode-card" onclick="startStarredReview()">
                    <h3>æ”¶è—å›é¡¾</h3>
                    <p>åªçœ‹æ”¶è—çš„<br>é‡ç‚¹é¢˜ç›®</p>
                </div>
                <div class="mode-card" onclick="startRedoStarred()">
                    <h3>æ”¶è—é‡åš</h3>
                    <p>é‡åšæ”¶è—çš„<br>é¢˜ç›®</p>
                </div>
            </div>

            <div style="margin-top: auto; padding: 20px 0;">
                <button class="small secondary" onclick="exportBook()">å¯¼å‡ºå‰©ä½™é”™é¢˜</button>
            </div>
        </div>
    </div>

    <!-- é”™é¢˜é‡åšé¡µé¢ -->
    <div id="view-redo" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="nav-bar">
            <button class="cfa-exit" onclick="backToBook()">PAUSE</button>
            <span style="color: var(--wrong-color); font-weight: 500;">å‰©ä½™: <span id="redo-count"></span></span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="redo-progress-bar" style="width: 0%;"></div>
        </div>
        <div class="scroll-content" style="max-width: 800px; margin: 0 auto; width: 100%;">
            <div id="redo-content"></div>
            <div id="redo-feedback" class="feedback-box"></div>
            <div style="margin-top: 25px; text-align: center;">
                <button id="redo-submit-btn" class="cfa-submit" onclick="checkRedo()">SUBMIT</button>
                <button id="redo-next-btn" class="cfa-next hidden" onclick="nextRedo()">NEXT â†’</button>
            </div>
            <!-- é‡åšé¡µé¢å·¥å…·æ  -->
            <div class="quiz-toolbar">
                <button class="cfa-tool tiny" onclick="openAIAssistantRedo()">ğŸ¤– AI æ±‚åŠ©</button>
                <button class="tiny secondary" onclick="openNoteModalRedo()">ğŸ“ æ·»åŠ ç¬”è®°</button>
            </div>
        </div>
    </div>

    <!-- é”™é¢˜å›é¡¾é¡µé¢ -->
    <div id="view-review" class="hidden" style="height: 100%; display: flex; flex-direction: column;">
        <div class="nav-bar">
            <button class="secondary" onclick="backToBook()">è¿”å›</button>
            <span id="review-mode-title" style="color: var(--text-light);">å›é¡¾æ¨¡å¼</span>
            <div style="width: 70px;"></div>
        </div>

        <div class="tag-section" style="padding: 0 5px;">
            <div class="tag-header">
                <span>æŒ‰æ ‡ç­¾ç­›é€‰</span>
                <button class="small secondary" onclick="clearReviewTagFilter()">æ¸…é™¤ç­›é€‰</button>
            </div>
            <div class="tag-container" id="review-tags"></div>
        </div>

        <div id="review-filter-info" class="filter-info hidden">
            <span id="review-filter-text">ç­›é€‰ç»“æœ</span>
        </div>

        <div id="review-list" class="scroll-content"></div>
    </div>

</div>

<!-- AI åŠ©æ‰‹å¼¹çª— -->
<div class="modal-overlay" id="ai-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ¤– AI åŠ©æ‰‹</h3>
            <button class="modal-close" onclick="closeAIModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="ai-chat-container">
                <div class="ai-messages" id="ai-messages">
                    <div class="ai-message system">AI åŠ©æ‰‹å·²å‡†å¤‡å°±ç»ªï¼Œé¢˜ç›®ä¿¡æ¯å·²è‡ªåŠ¨å¡«å…¥</div>
                </div>
                <div class="ai-input-area">
                    <textarea id="ai-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šä¸ºä»€ä¹ˆé€‰é¡¹ A æ˜¯é”™çš„ï¼Ÿè¿™é“é¢˜è€ƒå¯Ÿçš„çŸ¥è¯†ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"></textarea>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="accent" onclick="sendAIMessage()">å‘é€</button>
                        <button class="tiny secondary" onclick="clearAIChat()">æ¸…ç©º</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¬”è®°å¼¹çª— -->
<div class="modal-overlay" id="note-modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>ğŸ“ æ·»åŠ ç¬”è®°</h3>
            <button class="modal-close" onclick="closeNoteModal()">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="note-hint">
                ğŸ’¡ æç¤ºï¼šä½ å¯ä»¥åœ¨ AI å¯¹è¯ä¸­é€‰ä¸­æ–‡å­—ï¼Œç„¶åç‚¹å‡»"æ·»åŠ åˆ°ç¬”è®°"æŒ‰é’®å¿«é€Ÿæ·»åŠ å†…å®¹ã€‚
            </div>
            <textarea class="note-modal-textarea" id="note-input-modal" placeholder="åœ¨è¿™é‡Œè®°å½•ä½ å¯¹è¿™é“é¢˜çš„ç†è§£ã€æ˜“é”™ç‚¹ã€ç›¸å…³çŸ¥è¯†ç‚¹..."></textarea>
            <div class="btn-group">
                <button onclick="saveNoteFromModal()">ä¿å­˜ç¬”è®°</button>
                <button class="secondary" onclick="appendSelectedToNote()">ä»å‰ªè´´æ¿ç²˜è´´</button>
                <button class="secondary" onclick="closeNoteModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<!-- é€‰ä¸­æ–‡æœ¬å·¥å…·æç¤º -->
<div class="selection-tooltip" id="selection-tooltip" onclick="addSelectionToNote()">
    ğŸ“ æ·»åŠ åˆ°ç¬”è®°
</div>

<script>
    // ========== CFA æ ‡ç­¾ç³»ç»Ÿ ==========
    const CFA_TAGS = {
        'NPV': ['npv', 'net present value'], 'IRR': ['irr', 'internal rate of return'],
        'CAPM': ['capm', 'capital asset pricing'], 'Beta': ['beta', 'systematic risk'],
        'Duration': ['duration', 'macaulay'], 'YTM': ['ytm', 'yield to maturity'],
        'Bond': ['bond', 'coupon', 'face value'], 'Option': ['option', 'call', 'put', 'strike'],
        'Forward': ['forward', 'futures'], 'Swap': ['swap'],
        'P/E': ['p/e', 'price earnings'], 'ROE': ['roe', 'return on equity'],
        'EPS': ['eps', 'earnings per share'], 'FSA': ['financial statement', 'balance sheet'],
        'Portfolio': ['portfolio', 'diversification'], 'Ethics': ['ethics', 'standard', 'code of conduct'],
        'GIPS': ['gips'], 'GDP': ['gdp'], 'Inflation': ['inflation', 'cpi'],
        'FX': ['exchange rate', 'currency', 'forex'], 'Regression': ['regression', 'r-squared'],
        'Hypothesis': ['hypothesis', 't-test', 'p-value']
    };

    function detectTags(question) {
        const tags = [];
        const text = (question.question + ' ' + question.options.join(' ')).toLowerCase();
        for (const [tag, keywords] of Object.entries(CFA_TAGS)) {
            for (const keyword of keywords) {
                if (text.includes(keyword.toLowerCase())) { tags.push(tag); break; }
            }
        }
        return [...new Set(tags)];
    }

    function addTagsToQuestions(questions) {
        return questions.map(q => ({
            ...q, tags: q.tags || detectTags(q), errorCount: q.errorCount || 0, starred: q.starred || false, note: q.note || ''
        }));
    }

    function getAllUsedTags(questions) {
        const tagSet = new Set();
        questions.forEach(q => (q.tags || []).forEach(t => tagSet.add(t)));
        return Array.from(tagSet).sort();
    }

    function getTagClass(tag) {
        const t = tag.toLowerCase();
        if (t.includes('npv') || t.includes('irr')) return 'tag-npv';
        if (t.includes('capm') || t.includes('beta')) return 'tag-capm';
        if (t.includes('bond') || t.includes('duration')) return 'tag-bond';
        if (t.includes('option') || t.includes('forward') || t.includes('swap')) return 'tag-derivative';
        if (t.includes('ethic') || t.includes('gips')) return 'tag-ethics';
        if (t.includes('fsa')) return 'tag-fsa';
        if (t.includes('portfolio')) return 'tag-portfolio';
        if (t.includes('roe') || t.includes('eps')) return 'tag-equity';
        return '';
    }

    // ========== å…¨å±€æ•°æ® ==========
    let banks = [];
    let books = [];
    let currentBookId = null;
    let currentTagFilter = null;
    let reviewTagFilter = null;
    let searchQuery = '';
    let mergeMode = false;
    let selectedForMerge = new Set();
    let reviewMode = 'all';
    let redoMode = 'all';
    let redoOriginalCount = 0;
    
    let quizQuestions = [];
    let quizIndex = 0;
    let quizScore = 0;
    let quizMistakes = [];
    let quizAnswered = false;
    let lastQuizJSON = '';
    let currentQuizBankId = null;
    let timerEnabled = true;
    let timerInterval = null;
    let timerSeconds = 0;
    let currentQuizFlagged = false;

    let darkMode = localStorage.getItem('cfa_dark_mode') === 'true';
    let cloudConfig = { token: '', gistId: '', lastSync: null };
    
    // AI é…ç½®
    let aiConfig = {
        apiUrl: '',
        apiKey: '',
        model: '',
        systemPrompt: 'æˆ‘æ˜¯ä¸€å CFA å¤‡è€ƒè€ƒç”Ÿï¼Œæ­£åœ¨åˆ·é¢˜ç»ƒä¹ ã€‚è¯·å¸®æˆ‘åˆ†æä»¥ä¸‹é¢˜ç›®ï¼Œç”¨ä¸­æ–‡å›ç­”ï¼Œè§£é‡Šæ¸…æ¥šæ¯ä¸ªé€‰é¡¹ä¸ºä»€ä¹ˆå¯¹æˆ–é”™ï¼Œå¹¶è®²è§£ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚'
    };
    let aiChatHistory = [];
    let currentQuestionForAI = null;

    // ========== åˆå§‹åŒ– ==========
    window.onload = function() {
        loadCloudConfig();
        loadAIConfig();
        loadDataFromStorage();
        renderBanks();
        renderLibrary();
        renderLibraryTags();
        renderBankSelect();
        applyTheme();
        updateSyncStatus();
        setupSelectionListener();
    };

    // ========== Toast ==========
    function showToast(message, type = '') {
        const existing = document.querySelector('.toast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // ========== æ•°æ®æŒä¹…åŒ– ==========
    function loadDataFromStorage() {
        const savedBanks = localStorage.getItem('cfa_banks_v1');
        const savedBooks = localStorage.getItem('cfa_books_v1');
        if (savedBanks) banks = JSON.parse(savedBanks);
        if (savedBooks) books = JSON.parse(savedBooks);
    }

    function saveDataToStorage() {
        localStorage.setItem('cfa_banks_v1', JSON.stringify(banks));
        localStorage.setItem('cfa_books_v1', JSON.stringify(books));
    }

    // ========== AI é…ç½® ==========
    function loadAIConfig() {
        const saved = localStorage.getItem('cfa_ai_config');
        if (saved) {
            aiConfig = { ...aiConfig, ...JSON.parse(saved) };
            document.getElementById('ai-api-url').value = aiConfig.apiUrl || '';
            document.getElementById('ai-api-key').value = aiConfig.apiKey || '';
            document.getElementById('ai-model').value = aiConfig.model || '';
            document.getElementById('ai-system-prompt').value = aiConfig.systemPrompt || '';
        }
    }

    function saveAIConfig() {
        aiConfig.apiUrl = document.getElementById('ai-api-url').value.trim();
        aiConfig.apiKey = document.getElementById('ai-api-key').value.trim();
        aiConfig.model = document.getElementById('ai-model').value.trim();
        aiConfig.systemPrompt = document.getElementById('ai-system-prompt').value.trim();
        localStorage.setItem('cfa_ai_config', JSON.stringify(aiConfig));
        showToast('AI é…ç½®å·²ä¿å­˜', 'success');
        document.getElementById('ai-config-status').textContent = 'é…ç½®å·²ä¿å­˜';
    }

    function toggleAIKeyVisibility() {
        const input = document.getElementById('ai-api-key');
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function fetchAIModels() {
        const apiUrl = document.getElementById('ai-api-url').value.trim();
        const apiKey = document.getElementById('ai-api-key').value.trim();
        
        if (!apiUrl || !apiKey) {
            showToast('è¯·å…ˆå¡«å†™ API URL å’Œ Key', 'error');
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/models`, {
                headers: { 'Authorization': `Bearer ${apiKey}` }
            });
            
            if (!response.ok) throw new Error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥');
            
            const data = await response.json();
            const models = data.data || data.models || [];
            
            const select = document.getElementById('ai-model-select');
            select.innerHTML = '<option value="">-- é€‰æ‹©æ¨¡å‹ --</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id || model.name;
                option.textContent = model.id || model.name;
                select.appendChild(option);
            });
            
            select.style.display = 'block';
            select.onchange = function() {
                if (this.value) {
                    document.getElementById('ai-model').value = this.value;
                }
            };
            
            showToast(`è·å–åˆ° ${models.length} ä¸ªæ¨¡å‹`, 'success');
        } catch (e) {
            showToast('è·å–æ¨¡å‹å¤±è´¥: ' + e.message, 'error');
        }
    }

    async function testAIConnection() {
        const apiUrl = document.getElementById('ai-api-url').value.trim();
        const apiKey = document.getElementById('ai-api-key').value.trim();
        const model = document.getElementById('ai-model').value.trim();

        if (!apiUrl || !apiKey || !model) {
            showToast('è¯·å¡«å†™å®Œæ•´çš„ API é…ç½®', 'error');
            return;
        }

        try {
            const response = await fetch(`${apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'user', content: 'ä½ å¥½ï¼Œè¯·å›å¤"è¿æ¥æˆåŠŸ"' }],
                    max_tokens: 50
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'è¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content || 'æ— å›å¤';
            showToast('è¿æ¥æˆåŠŸ: ' + reply.substring(0, 30), 'success');
            document.getElementById('ai-config-status').textContent = 'âœ… è¿æ¥æµ‹è¯•æˆåŠŸ';
        } catch (e) {
            showToast('è¿æ¥å¤±è´¥: ' + e.message, 'error');
            document.getElementById('ai-config-status').textContent = 'âŒ è¿æ¥å¤±è´¥: ' + e.message;
        }
    }

    // ========== AI åŠ©æ‰‹å¼¹çª— ==========
    function openAIAssistant() {
        if (!aiConfig.apiUrl || !aiConfig.apiKey || !aiConfig.model) {
            showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® AI API', 'error');
            switchMainTab('settings');
            backToMain();
            return;
        }

        const q = quizQuestions[quizIndex];
        currentQuestionForAI = q;
        
        // æ„å»ºé¢˜ç›®ä¿¡æ¯
        let questionInfo = `ã€é¢˜ç›®ã€‘\n${q.question}\n\nã€é€‰é¡¹ã€‘\n${q.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}`;
        
        // æ ¹æ®ç­”é¢˜çŠ¶æ€å†³å®šæ˜¯å¦æ˜¾ç¤ºç­”æ¡ˆ
        if (quizAnswered) {
            const userChoice = document.querySelector('input[name="quiz-opt"]:checked')?.value || 'æœªé€‰æ‹©';
            const isCorrect = userChoice === q.answer;
            questionInfo += `\n\nã€ç­”é¢˜æƒ…å†µã€‘`;
            questionInfo += `\næˆ‘é€‰æ‹©äº†: ${userChoice}`;
            questionInfo += `\næ­£ç¡®ç­”æ¡ˆ: ${q.answer}`;
            questionInfo += `\nç»“æœ: ${isCorrect ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}`;
        } else {
            questionInfo += `\n\nï¼ˆæˆ‘è¿˜æ²¡æœ‰ä½œç­”ï¼Œè¯·ä¸è¦ç›´æ¥å‘Šè¯‰æˆ‘ç­”æ¡ˆï¼Œè€Œæ˜¯å¸®æˆ‘åˆ†æè§£é¢˜æ€è·¯ï¼‰`;
        }

        // é‡ç½®èŠå¤©å†å²
        aiChatHistory = [{
            role: 'system',
            content: aiConfig.systemPrompt
        }, {
            role: 'user',
            content: questionInfo
        }];

        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('ai-modal').classList.add('active');
        document.getElementById('ai-messages').innerHTML = `
            <div class="ai-message system">é¢˜ç›®ä¿¡æ¯å·²è‡ªåŠ¨å‘é€ç»™ AIï¼Œè¯·ç¨å€™...</div>
        `;
        document.getElementById('ai-input').value = '';

        // è‡ªåŠ¨å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
        sendInitialAIMessage(questionInfo);
    }

    function openAIAssistantRedo() {
        if (!aiConfig.apiUrl || !aiConfig.apiKey || !aiConfig.model) {
            showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® AI API', 'error');
            return;
        }

        const book = getCurrentBook();
        let questions = redoMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
        const q = questions[0]; // å½“å‰é‡åšçš„é¢˜ç›®
        
        if (!q) return;
        
        currentQuestionForAI = q;
        
        let questionInfo = `ã€é¢˜ç›®ã€‘\n${q.question}\n\nã€é€‰é¡¹ã€‘\n${q.options.map((opt, i) => `${String.fromCharCode(65 + i)}. ${opt}`).join('\n')}`;
        
        const redoFeedback = document.getElementById('redo-feedback');
        const isAnswered = redoFeedback.style.display === 'block';
        
        if (isAnswered) {
            questionInfo += `\n\nã€è¿™æ˜¯æˆ‘ä¹‹å‰åšé”™çš„é¢˜ã€‘`;
            questionInfo += `\næ­£ç¡®ç­”æ¡ˆ: ${q.answer}`;
            if (q.user_wrong_choice) {
                questionInfo += `\næˆ‘ä¹‹å‰é€‰é”™çš„: ${q.user_wrong_choice}`;
            }
        } else {
            questionInfo += `\n\nï¼ˆæˆ‘è¿˜æ²¡æœ‰ä½œç­”ï¼Œè¯·ä¸è¦ç›´æ¥å‘Šè¯‰æˆ‘ç­”æ¡ˆï¼Œè€Œæ˜¯å¸®æˆ‘åˆ†æè§£é¢˜æ€è·¯ï¼‰`;
        }

        aiChatHistory = [{
            role: 'system',
            content: aiConfig.systemPrompt
        }, {
            role: 'user',
            content: questionInfo
        }];

        document.getElementById('ai-modal').classList.add('active');
        document.getElementById('ai-messages').innerHTML = `
            <div class="ai-message system">é¢˜ç›®ä¿¡æ¯å·²è‡ªåŠ¨å‘é€ç»™ AIï¼Œè¯·ç¨å€™...</div>
        `;
        document.getElementById('ai-input').value = '';

        sendInitialAIMessage(questionInfo);
    }

    async function sendInitialAIMessage(content) {
        const messagesDiv = document.getElementById('ai-messages');
        
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        messagesDiv.innerHTML = `
            <div class="ai-message user">
                <div class="ai-message-label">æˆ‘</div>
                ${escapeHtml(content).replace(/\n/g, '<br>')}
            </div>
            <div class="ai-loading">
                <div class="ai-loading-dots"><span></span><span></span><span></span></div>
                AI æ­£åœ¨æ€è€ƒ...
            </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
            const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: aiConfig.model,
                    messages: aiChatHistory,
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'è¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content || 'æ— å›å¤';

            // æ·»åŠ åˆ°å†å²
            aiChatHistory.push({ role: 'assistant', content: reply });

            // æ˜¾ç¤ºå›å¤
            messagesDiv.innerHTML = `
                <div class="ai-message user">
                    <div class="ai-message-label">æˆ‘</div>
                    ${escapeHtml(content).replace(/\n/g, '<br>')}
                </div>
                <div class="ai-message assistant">
                    <div class="ai-message-label">AI åŠ©æ‰‹</div>
                    ${formatAIResponse(reply)}
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

        } catch (e) {
            messagesDiv.innerHTML += `
                <div class="ai-message system" style="color: var(--wrong-color);">
                    âŒ è¯·æ±‚å¤±è´¥: ${e.message}
                </div>
            `;
        }
    }

    async function sendAIMessage() {
        const input = document.getElementById('ai-input');
        const content = input.value.trim();
        
        if (!content) return;

        input.value = '';
        const messagesDiv = document.getElementById('ai-messages');

        // æ·»åŠ åˆ°å†å²
        aiChatHistory.push({ role: 'user', content: content });

        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        messagesDiv.innerHTML += `
            <div class="ai-message user">
                <div class="ai-message-label">æˆ‘</div>
                ${escapeHtml(content).replace(/\n/g, '<br>')}
            </div>
            <div class="ai-loading">
                <div class="ai-loading-dots"><span></span><span></span><span></span></div>
                AI æ­£åœ¨æ€è€ƒ...
            </div>
        `;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        try {
            const response = await fetch(`${aiConfig.apiUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: aiConfig.model,
                    messages: aiChatHistory,
                    max_tokens: 2000,
                    temperature: 0.7
                })
            });

            // ç§»é™¤ loading
            const loading = messagesDiv.querySelector('.ai-loading');
            if (loading) loading.remove();

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'è¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();
            const reply = data.choices?.[0]?.message?.content || 'æ— å›å¤';

            aiChatHistory.push({ role: 'assistant', content: reply });

            messagesDiv.innerHTML += `
                <div class="ai-message assistant">
                    <div class="ai-message-label">AI åŠ©æ‰‹</div>
                    ${formatAIResponse(reply)}
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

        } catch (e) {
            const loading = messagesDiv.querySelector('.ai-loading');
            if (loading) loading.remove();
            
            messagesDiv.innerHTML += `
                <div class="ai-message system" style="color: var(--wrong-color);">
                    âŒ è¯·æ±‚å¤±è´¥: ${e.message}
                </div>
            `;
        }
    }

    function formatAIResponse(text) {
        // ç®€å•æ ¼å¼åŒ–ï¼šè½¬ä¹‰ HTMLï¼Œä¿ç•™æ¢è¡Œï¼Œå¤„ç†ä»£ç å—
        let formatted = escapeHtml(text);
        formatted = formatted.replace(/\n/g, '<br>');
        // åŠ ç²— **text**
        formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        return formatted;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function clearAIChat() {
        aiChatHistory = [];
        document.getElementById('ai-messages').innerHTML = `
            <div class="ai-message system">å¯¹è¯å·²æ¸…ç©ºï¼Œå¯ä»¥å¼€å§‹æ–°çš„æé—®</div>
        `;
    }

    function closeAIModal() {
        document.getElementById('ai-modal').classList.remove('active');
    }

    // ========== ç¬”è®°åŠŸèƒ½ ==========
    function openNoteModal() {
        const q = quizQuestions[quizIndex];
        document.getElementById('note-input-modal').value = q.note || '';
        document.getElementById('note-modal').classList.add('active');
    }

    function openNoteModalRedo() {
        const book = getCurrentBook();
        let questions = redoMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
        const q = questions[0];
        if (q) {
            document.getElementById('note-input-modal').value = q.note || '';
            document.getElementById('note-modal').classList.add('active');
        }
    }

    function closeNoteModal() {
        document.getElementById('note-modal').classList.remove('active');
    }

    function saveNoteFromModal() {
        const note = document.getElementById('note-input-modal').value.trim();
        
        // åˆ¤æ–­å½“å‰æ˜¯åœ¨åˆ·é¢˜è¿˜æ˜¯é‡åš
        const quizView = document.getElementById('view-quiz');
        const redoView = document.getElementById('view-redo');
        
        if (!quizView.classList.contains('hidden')) {
            // åˆ·é¢˜æ¨¡å¼
            quizQuestions[quizIndex].note = note;
            // å¦‚æœè¿™é¢˜å·²ç»é”™äº†å¹¶åŠ å…¥é”™é¢˜æœ¬ï¼Œä¹Ÿæ›´æ–°é”™é¢˜æœ¬
            updateNoteInMistakeBook(quizQuestions[quizIndex], note);
        } else if (!redoView.classList.contains('hidden')) {
            // é‡åšæ¨¡å¼
            const book = getCurrentBook();
            let questions = redoMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
            if (questions[0]) {
                const qIndex = book.mistakes.indexOf(questions[0]);
                if (qIndex >= 0) {
                    book.mistakes[qIndex].note = note;
                    saveDataToStorage();
                }
            }
        }
        
        showToast('ç¬”è®°å·²ä¿å­˜', 'success');
        closeNoteModal();
    }

    function updateNoteInMistakeBook(question, note) {
        // åœ¨æ‰€æœ‰é”™é¢˜æœ¬ä¸­æŸ¥æ‰¾å¹¶æ›´æ–°
        books.forEach(book => {
            const idx = book.mistakes.findIndex(m => m.question === question.question);
            if (idx >= 0) {
                book.mistakes[idx].note = note;
            }
        });
        saveDataToStorage();
    }

    async function appendSelectedToNote() {
        try {
            const text = await navigator.clipboard.readText();
            if (text) {
                const textarea = document.getElementById('note-input-modal');
                textarea.value = textarea.value ? textarea.value + '\n\n---\n\n' + text : text;
                showToast('å·²ç²˜è´´å†…å®¹', 'success');
            }
        } catch (e) {
            showToast('æ— æ³•è¯»å–å‰ªè´´æ¿', 'error');
        }
    }

    // é€‰ä¸­æ–‡æœ¬ç›‘å¬
    let selectedText = '';
    function setupSelectionListener() {
        document.addEventListener('mouseup', function(e) {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            const tooltip = document.getElementById('selection-tooltip');
            
            if (text && document.getElementById('ai-modal').classList.contains('active')) {
                selectedText = text;
                tooltip.style.display = 'block';
                tooltip.style.left = e.pageX + 'px';
                tooltip.style.top = (e.pageY - 40) + 'px';
            } else {
                tooltip.style.display = 'none';
            }
        });

        document.addEventListener('mousedown', function(e) {
            if (!e.target.closest('.selection-tooltip')) {
                document.getElementById('selection-tooltip').style.display = 'none';
            }
        });
    }

    function addSelectionToNote() {
        if (selectedText) {
            // æ‰“å¼€ç¬”è®°å¼¹çª—å¹¶æ·»åŠ é€‰ä¸­çš„æ–‡æœ¬
            document.getElementById('note-modal').classList.add('active');
            const textarea = document.getElementById('note-input-modal');
            
            // è·å–å½“å‰é¢˜ç›®çš„ç¬”è®°
            const quizView = document.getElementById('view-quiz');
            const redoView = document.getElementById('view-redo');
            let currentNote = '';
            
            if (!quizView.classList.contains('hidden')) {
                currentNote = quizQuestions[quizIndex].note || '';
            } else if (!redoView.classList.contains('hidden')) {
                const book = getCurrentBook();
                let questions = redoMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
                if (questions[0]) {
                    currentNote = questions[0].note || '';
                }
            }
            
            textarea.value = currentNote ? currentNote + '\n\n---\nã€AI è§£ç­”æ‘˜å½•ã€‘\n' + selectedText : 'ã€AI è§£ç­”æ‘˜å½•ã€‘\n' + selectedText;
            document.getElementById('selection-tooltip').style.display = 'none';
            showToast('å·²æ·»åŠ åˆ°ç¬”è®°', 'success');
        }
    }

    // ========== é¢˜ç›®æ ‡è®° ==========
    function toggleQuizFlag() {
        currentQuizFlagged = !currentQuizFlagged;
        const btn = document.getElementById('quiz-flag-btn');
        btn.textContent = currentQuizFlagged ? 'ğŸš© å·²æ ‡è®°' : 'ğŸš© æ ‡è®°';
        btn.style.background = currentQuizFlagged ? 'var(--cfa-warning)' : '';
        btn.style.color = currentQuizFlagged ? 'white' : '';
    }

    // ========== äº‘åŒæ­¥ ==========
    function loadCloudConfig() {
        const saved = localStorage.getItem('cfa_cloud_config');
        if (saved) {
            cloudConfig = JSON.parse(saved);
            document.getElementById('github-token').value = cloudConfig.token || '';
            document.getElementById('gist-id').value = cloudConfig.gistId || '';
        }
    }

    function saveCloudConfig() {
        cloudConfig.token = document.getElementById('github-token').value.trim();
        cloudConfig.gistId = document.getElementById('gist-id').value.trim();
        localStorage.setItem('cfa_cloud_config', JSON.stringify(cloudConfig));
        showToast('é…ç½®å·²ä¿å­˜', 'success');
        updateSyncStatus();
    }

    function updateSyncStatus() {
        const dot = document.getElementById('sync-dot');
        const text = document.getElementById('sync-text');
        const btn = document.getElementById('sync-btn');
        
        if (cloudConfig.token && cloudConfig.gistId) {
            dot.classList.add('connected'); text.textContent = 'å·²è¿æ¥'; btn.classList.add('synced');
        } else if (cloudConfig.token) {
            dot.classList.remove('connected'); text.textContent = 'å¾…é…ç½®'; btn.classList.remove('synced');
        } else {
            dot.classList.remove('connected'); text.textContent = 'æœ¬åœ°æ¨¡å¼'; btn.classList.remove('synced');
        }
    }

    function toggleTokenVisibility() {
        const input = document.getElementById('github-token');
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    async function testConnection() {
        const token = document.getElementById('github-token').value.trim();
        if (!token) { showToast('è¯·å…ˆè¾“å…¥ Token', 'error'); return; }
        try {
            const response = await fetch('https://api.github.com/user', { headers: { 'Authorization': `token ${token}` } });
            if (response.ok) { const user = await response.json(); showToast(`è¿æ¥æˆåŠŸ: ${user.login}`, 'success'); }
            else showToast('Token æ— æ•ˆ', 'error');
        } catch (e) { showToast('è¿æ¥å¤±è´¥: ' + e.message, 'error'); }
    }

    async function uploadToCloud() {
        if (!cloudConfig.token) { showToast('è¯·å…ˆé…ç½® Token', 'error'); return; }
        const syncBtn = document.getElementById('sync-btn');
        const dot = document.getElementById('sync-dot');
        syncBtn.classList.add('syncing'); dot.classList.add('syncing');

        try {
            const data = { banks, books, exportTime: new Date().toISOString(), version: 3 };
            const content = JSON.stringify(data, null, 2);
            
            if (cloudConfig.gistId) {
                const response = await fetch(`https://api.github.com/gists/${cloudConfig.gistId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `token ${cloudConfig.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: { 'cfa_study_data.json': { content } } })
                });
                if (!response.ok) throw new Error('æ›´æ–°å¤±è´¥');
                showToast('ä¸Šä¼ æˆåŠŸ', 'success');
            } else {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: { 'Authorization': `token ${cloudConfig.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: 'CFA Study System Data', public: false, files: { 'cfa_study_data.json': { content } } })
                });
                if (!response.ok) throw new Error('åˆ›å»ºå¤±è´¥');
                const gist = await response.json();
                cloudConfig.gistId = gist.id;
                document.getElementById('gist-id').value = gist.id;
                localStorage.setItem('cfa_cloud_config', JSON.stringify(cloudConfig));
                showToast('å·²åˆ›å»ºæ–° Gist å¹¶ä¸Šä¼ ', 'success');
            }
            cloudConfig.lastSync = new Date().toISOString();
            localStorage.setItem('cfa_cloud_config', JSON.stringify(cloudConfig));
            updateCloudStatus();
        } catch (e) { showToast('ä¸Šä¼ å¤±è´¥: ' + e.message, 'error'); }
        finally { syncBtn.classList.remove('syncing'); dot.classList.remove('syncing'); updateSyncStatus(); }
    }

    async function downloadFromCloud() {
        if (!cloudConfig.token || !cloudConfig.gistId) { showToast('è¯·å…ˆé…ç½® Token å’Œ Gist ID', 'error'); return; }
        const syncBtn = document.getElementById('sync-btn');
        const dot = document.getElementById('sync-dot');
        syncBtn.classList.add('syncing'); dot.classList.add('syncing');

        try {
            const response = await fetch(`https://api.github.com/gists/${cloudConfig.gistId}`, { headers: { 'Authorization': `token ${cloudConfig.token}` } });
            if (!response.ok) throw new Error('è·å–å¤±è´¥');
            const gist = await response.json();
            const file = gist.files['cfa_study_data.json'];
            if (!file) throw new Error('æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨');
            const data = JSON.parse(file.content);
            
            if (data.banks) banks = data.banks;
            if (data.books) books = data.books;
            saveDataToStorage();
            renderBanks(); renderLibrary(); renderLibraryTags(); renderBankSelect();
            showToast(`å·²ä¸‹è½½ ${banks.length} å¥—é¢˜åº“, ${books.length} ä¸ªé”™é¢˜æœ¬`, 'success');
            cloudConfig.lastSync = new Date().toISOString();
            localStorage.setItem('cfa_cloud_config', JSON.stringify(cloudConfig));
            updateCloudStatus();
        } catch (e) { showToast('ä¸‹è½½å¤±è´¥: ' + e.message, 'error'); }
        finally { syncBtn.classList.remove('syncing'); dot.classList.remove('syncing'); }
    }

    async function manualSync() {
        if (!cloudConfig.token || !cloudConfig.gistId) { showToast('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®äº‘åŒæ­¥', 'error'); switchMainTab('settings'); return; }
        await uploadToCloud();
    }

    function updateCloudStatus() {
        const status = document.getElementById('cloud-status');
        if (cloudConfig.lastSync) {
            const date = new Date(cloudConfig.lastSync);
            status.textContent = `ä¸Šæ¬¡åŒæ­¥: ${date.toLocaleString()}`;
        } else { status.textContent = ''; }
    }

    // ========== æœ¬åœ°å¤‡ä»½ ==========
    function exportAllData() {
        const data = { banks, books, exportTime: new Date().toISOString(), version: 3 };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `cfa_study_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click(); URL.revokeObjectURL(url);
        showToast('å¯¼å‡ºæˆåŠŸ', 'success');
    }

    function importAllData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (confirm(`ç¡®å®šè¦å¯¼å…¥æ•°æ®å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ã€‚`)) {
                    if (data.banks) banks = data.banks;
                    if (data.books) books = data.books;
                    saveDataToStorage();
                    renderBanks(); renderLibrary(); renderLibraryTags(); renderBankSelect();
                    showToast('å¯¼å…¥æˆåŠŸ', 'success');
                }
            } catch (err) { showToast('å¯¼å…¥å¤±è´¥: ' + err.message, 'error'); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    function clearAllData() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            if (confirm('å†æ¬¡ç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰é¢˜åº“å’Œé”™é¢˜æœ¬ï¼')) {
                banks = []; books = [];
                saveDataToStorage();
                renderBanks(); renderLibrary(); renderLibraryTags(); renderBankSelect();
                showToast('æ•°æ®å·²æ¸…é™¤', 'success');
            }
        }
    }

    // ========== ä¸»é¢˜ ==========
    function toggleTheme() {
        darkMode = !darkMode;
        localStorage.setItem('cfa_dark_mode', darkMode);
        applyTheme();
    }

    function applyTheme() {
        document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
        document.getElementById('theme-icon').textContent = darkMode ? 'L' : 'D';
    }

    // ========== è®¡æ—¶å™¨ ==========
    function startTimer() {
        if (!timerEnabled) { document.getElementById('quiz-timer').style.display = 'none'; return; }
        document.getElementById('quiz-timer').style.display = 'block';
        timerSeconds = 0; updateTimerDisplay();
        timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
    }
    function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
    function updateTimerDisplay() {
        const mins = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
        const secs = (timerSeconds % 60).toString().padStart(2, '0');
        document.getElementById('quiz-timer').textContent = `${mins}:${secs}`;
    }
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }
    function shuffleArray(array) {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; }
        return arr;
    }

    // ========== é¡µé¢åˆ‡æ¢ ==========
    function switchMainTab(tab) {
        const tabs = ['quiz', 'banks', 'library', 'stats', 'settings'];
        document.querySelectorAll('.main-tabs .tab-btn').forEach((btn, i) => btn.classList.toggle('active', tabs[i] === tab));
        tabs.forEach(t => document.getElementById(`tab-${t}`).classList.toggle('hidden', t !== tab));
        if (tab === 'banks') renderBanks();
        if (tab === 'library') { renderLibrary(); renderLibraryTags(); }
        if (tab === 'stats') renderStats();
        if (tab === 'settings') updateCloudStatus();
        if (tab === 'quiz') renderBankSelect();
    }

    function backToMain() {
        stopTimer(); hideAllViews();
        document.getElementById('view-main').style.display = 'flex';
        renderBanks(); renderLibrary(); renderLibraryTags(); renderBankSelect();
    }

    function hideAllViews() {
        ['view-main', 'view-add-bank', 'view-import', 'view-quiz', 'view-quiz-result', 'view-book', 'view-redo', 'view-review'].forEach(id => {
            document.getElementById(id).style.display = 'none';
            document.getElementById(id).classList.add('hidden');
        });
    }

    function showView(viewId) {
        hideAllViews();
        const el = document.getElementById(viewId);
        el.classList.remove('hidden'); el.style.display = 'flex';
    }

    // ========== é¢˜åº“ç®¡ç† ==========
    function renderBanks() {
        const container = document.getElementById('banks-container');
        document.getElementById('total-banks').textContent = banks.length;

        if (banks.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>è¿˜æ²¡æœ‰é¢˜åº“</p><p>ç‚¹å‡»å³ä¸Šè§’æ·»åŠ </p></div>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'library-grid';

        banks.forEach(bank => {
            const card = document.createElement('div');
            card.className = 'book-card quiz-bank';
            const tags = getAllUsedTags(bank.questions).slice(0, 3);
            
            card.innerHTML = `
                <div>
                    <div class="book-title">${bank.name}</div>
                    <div class="book-stats">å…± <strong>${bank.questions.length}</strong> é“é¢˜</div>
                    ${tags.length > 0 ? `<div class="question-tags">${tags.map(t => `<span class="question-tag">${t}</span>`).join('')}</div>` : ''}
                </div>
                <div class="book-actions">
                    <button class="small" onclick="startQuizFromBankId('${bank.id}')">åˆ·é¢˜</button>
                    <button class="small secondary" onclick="exportBank('${bank.id}')">å¯¼å‡º</button>
                    <button class="small danger" onclick="deleteBank('${bank.id}')">åˆ é™¤</button>
                </div>
            `;
            grid.appendChild(card);
        });
        container.innerHTML = '';
        container.appendChild(grid);
    }

    function renderBankSelect() {
        const select = document.getElementById('quiz-bank-select');
        select.innerHTML = '<option value="">-- é€‰æ‹©é¢˜åº“ --</option>';
        banks.forEach(bank => {
            const option = document.createElement('option');
            option.value = bank.id;
            option.textContent = `${bank.name} (${bank.questions.length} é¢˜)`;
            select.appendChild(option);
        });
    }

    function showAddBankView() {
        document.getElementById('bank-name-input').value = '';
        document.getElementById('bank-json-input').value = '';
        document.getElementById('bank-error').textContent = '';
        showView('view-add-bank');
    }

    function saveNewBank() {
        const name = document.getElementById('bank-name-input').value.trim();
        const jsonStr = document.getElementById('bank-json-input').value;

        if (!name) { document.getElementById('bank-error').textContent = 'è¯·è¾“å…¥é¢˜åº“åç§°'; return; }

        try {
            let data = JSON.parse(jsonStr);
            if (!Array.isArray(data) || data.length === 0) throw new Error('å¿…é¡»æ˜¯éç©ºæ•°ç»„');
            if (!data[0].question || !data[0].answer) throw new Error('æ ¼å¼é”™è¯¯');
            
            data = addTagsToQuestions(data);
            banks.push({ id: Date.now().toString(), name, questions: data, createdAt: new Date().toISOString() });
            saveDataToStorage();
            showToast(`å·²æ·»åŠ  ${data.length} é“é¢˜`, 'success');
            backToMain();
            switchMainTab('banks');
        } catch (e) {
            document.getElementById('bank-error').textContent = 'JSONé”™è¯¯: ' + e.message;
        }
    }

    function deleteBank(id) {
        if (confirm('ç¡®å®šåˆ é™¤è¿™å¥—é¢˜åº“ï¼Ÿ')) {
            banks = banks.filter(b => b.id !== id);
            saveDataToStorage();
            renderBanks();
            renderBankSelect();
        }
    }

    function exportBank(id) {
        const bank = banks.find(b => b.id === id);
        if (bank) {
            navigator.clipboard.writeText(JSON.stringify(bank.questions, null, 2)).then(() => showToast('å·²å¤åˆ¶ JSON', 'success'));
        }
    }

    function startQuizFromBank() {
        const bankId = document.getElementById('quiz-bank-select').value;
        if (!bankId) { showToast('è¯·é€‰æ‹©é¢˜åº“', 'error'); return; }
        startQuizFromBankId(bankId);
    }

    function startQuizFromBankId(bankId) {
        const bank = banks.find(b => b.id === bankId);
        if (!bank) { showToast('é¢˜åº“ä¸å­˜åœ¨', 'error'); return; }
        
        currentQuizBankId = bankId;
        quizQuestions = addTagsToQuestions([...bank.questions]);
        
        const shouldShuffle = document.getElementById('shuffle-checkbox').checked;
        timerEnabled = document.getElementById('timer-checkbox').checked;
        
        if (shouldShuffle) quizQuestions = shuffleArray(quizQuestions);
        
        lastQuizJSON = JSON.stringify(bank.questions);
        quizIndex = 0; quizScore = 0; quizMistakes = [];
        
        showView('view-quiz');
        startTimer();
        renderQuizQuestion();
    }

    // ========== æœç´¢ ==========
    function handleSearch() { searchQuery = document.getElementById('search-input').value.trim().toLowerCase(); renderLibrary(); updateFilterInfo(); }
    function clearSearch() { document.getElementById('search-input').value = ''; searchQuery = ''; renderLibrary(); updateFilterInfo(); }
    function clearAllFilters() { clearSearch(); clearTagFilter(); }
    function updateFilterInfo() {
        const hasFilter = searchQuery || currentTagFilter;
        document.getElementById('filter-info').classList.toggle('hidden', !hasFilter);
        let text = 'ç­›é€‰: ';
        if (currentTagFilter) text += `[${currentTagFilter}] `;
        if (searchQuery) text += `"${searchQuery}" `;
        document.getElementById('filter-text').textContent = text;
    }

    // ========== åˆå¹¶ ==========
    function toggleMergeMode() {
        mergeMode = !mergeMode; selectedForMerge.clear();
        document.getElementById('merge-btn').textContent = mergeMode ? 'å–æ¶ˆåˆå¹¶' : 'åˆå¹¶æ¨¡å¼';
        document.getElementById('merge-toolbar').classList.toggle('hidden', !mergeMode);
        renderLibrary();
    }
    function toggleBookSelection(id) {
        if (selectedForMerge.has(id)) selectedForMerge.delete(id);
        else selectedForMerge.add(id);
        document.getElementById('merge-count').textContent = selectedForMerge.size;
        renderLibrary();
    }
    function cancelMerge() {
        mergeMode = false; selectedForMerge.clear();
        document.getElementById('merge-btn').textContent = 'åˆå¹¶æ¨¡å¼';
        document.getElementById('merge-toolbar').classList.add('hidden');
        renderLibrary();
    }
    function executeMerge() {
        if (selectedForMerge.size < 2) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸¤ä¸ª'); return; }
        const name = prompt('è¯·è¾“å…¥åˆå¹¶åçš„åç§°:');
        if (!name) return;
        const selectedBooks = books.filter(b => selectedForMerge.has(b.id));
        const allMistakes = [], allSolved = [];
        selectedBooks.forEach(book => {
            book.mistakes.forEach(q => { if (!allMistakes.some(m => m.question === q.question)) allMistakes.push(q); });
            (book.solved || []).forEach(q => { if (!allSolved.some(m => m.question === q.question)) allSolved.push(q); });
        });
        books = books.filter(b => !selectedForMerge.has(b.id));
        books.push({ id: Date.now().toString(), name, mistakes: allMistakes, solved: allSolved });
        saveDataToStorage(); cancelMerge();
        showToast(`å·²åˆå¹¶ä¸º ${allMistakes.length} é“é”™é¢˜`, 'success');
    }

    // ========== ç»Ÿè®¡ ==========
    function renderStats() {
        let totalMistakes = 0, totalSolved = 0, totalStarred = 0;
        const tagCounts = {};
        const allMistakes = [];
        
        books.forEach(book => {
            totalMistakes += book.mistakes.length;
            totalSolved += (book.solved || []).length;
            book.mistakes.forEach(q => {
                if (q.starred) totalStarred++;
                (q.tags || []).forEach(t => tagCounts[t] = (tagCounts[t] || 0) + 1);
                allMistakes.push(q);
            });
        });
        
        document.getElementById('stat-total-banks').textContent = banks.length;
        document.getElementById('stat-total-mistakes').textContent = totalMistakes;
        document.getElementById('stat-total-solved').textContent = totalSolved;
        document.getElementById('stat-total-starred').textContent = totalStarred;
        
        const tagContainer = document.getElementById('tag-stats-container');
        const sortedTags = Object.entries(tagCounts).sort((a, b) => b[1] - a[1]);
        const maxCount = sortedTags.length > 0 ? sortedTags[0][1] : 1;
        
        tagContainer.innerHTML = sortedTags.length === 0 
            ? '<p style="color: var(--text-light); text-align: center;">æš‚æ— æ•°æ®</p>'
            : sortedTags.slice(0, 15).map(([tag, count]) => `
                <div class="tag-stat-row">
                    <span class="tag-stat-name">${tag}</span>
                    <div class="tag-stat-bar"><div class="tag-stat-fill" style="width: ${count / maxCount * 100}%"></div></div>
                    <span class="tag-stat-count">${count} é¢˜</span>
                </div>
            `).join('');
        
        const frequentContainer = document.getElementById('frequent-mistakes-container');
        const sortedMistakes = allMistakes.filter(q => q.errorCount > 1).sort((a, b) => (b.errorCount || 0) - (a.errorCount || 0));
        frequentContainer.innerHTML = sortedMistakes.length === 0 
            ? '<p style="color: var(--text-light); text-align: center;">æš‚æ— é«˜é¢‘é”™é¢˜</p>'
            : sortedMistakes.slice(0, 5).map(q => `
                <div style="padding: 12px; background: var(--card-bg); border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--wrong-color);">
                    <div style="font-size: 13px; line-height: 1.5;">${q.question.substring(0, 100)}${q.question.length > 100 ? '...' : ''}</div>
                    <div style="font-size: 12px; color: var(--wrong-color); margin-top: 5px;">é”™è¯¯ ${q.errorCount} æ¬¡</div>
                </div>
            `).join('');
    }

    // ========== é”™é¢˜æœ¬ ==========
    function renderLibrary() {
        const container = document.getElementById('library-container');
        document.getElementById('total-books').textContent = books.length;

        let filteredBooks = books;
        if (currentTagFilter) {
            filteredBooks = books.filter(b => b.mistakes.some(q => (q.tags || []).includes(currentTagFilter)));
        }

        if (filteredBooks.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>æ²¡æœ‰é”™é¢˜æœ¬</p><p>åˆ·é¢˜åä¼šè‡ªåŠ¨æ·»åŠ é”™é¢˜</p></div>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'library-grid';

        filteredBooks.forEach(book => {
            let displayMistakes = book.mistakes;
            if (searchQuery) {
                displayMistakes = displayMistakes.filter(q => q.question.toLowerCase().includes(searchQuery));
            }
            if (currentTagFilter) {
                displayMistakes = displayMistakes.filter(q => (q.tags || []).includes(currentTagFilter));
            }

            const card = document.createElement('div');
            card.className = 'book-card';
            
            if (mergeMode) {
                card.innerHTML = `
                    <div class="merge-checkbox">
                        <input type="checkbox" ${selectedForMerge.has(book.id) ? 'checked' : ''} onchange="toggleBookSelection('${book.id}')">
                    </div>
                `;
            }
            
            const tags = getAllUsedTags(book.mistakes).slice(0, 3);
            card.innerHTML += `
                <div>
                    <div class="book-title">${book.name}</div>
                    <div class="book-stats">
                        å¾…æ”»å…‹: <strong style="color: var(--wrong-color);">${book.mistakes.length}</strong> | 
                        å·²æ–©æ€: <strong style="color: var(--correct-color);">${(book.solved || []).length}</strong>
                        ${searchQuery || currentTagFilter ? `<br>ç­›é€‰ç»“æœ: ${displayMistakes.length} é¢˜` : ''}
                    </div>
                    ${tags.length > 0 ? `<div class="question-tags">${tags.map(t => `<span class="question-tag">${t}</span>`).join('')}</div>` : ''}
                </div>
                <div class="book-actions">
                    <button class="small" onclick="openBook('${book.id}')">æ‰“å¼€</button>
                    <button class="small secondary" onclick="renameBook('${book.id}')">é‡å‘½å</button>
                    <button class="small danger" onclick="deleteBook('${book.id}')">åˆ é™¤</button>
                </div>
            `;
            grid.appendChild(card);
        });

        container.innerHTML = '';
        container.appendChild(grid);
    }

    function renderLibraryTags() {
        const allTags = new Set();
        books.forEach(book => book.mistakes.forEach(q => (q.tags || []).forEach(t => allTags.add(t))));
        const tagContainer = document.getElementById('library-tags');
        tagContainer.innerHTML = Array.from(allTags).sort().map(tag =>
            `<span class="tag ${getTagClass(tag)} ${currentTagFilter === tag ? 'active' : ''}" onclick="filterByTag('${tag}')">${tag}</span>`
        ).join('') || '<span style="color: var(--text-light);">æš‚æ— æ ‡ç­¾</span>';
    }

    window.filterByTag = function(tag) {
        currentTagFilter = currentTagFilter === tag ? null : tag;
        renderLibraryTags();
        renderLibrary();
        updateFilterInfo();
    };

    function clearTagFilter() {
        currentTagFilter = null;
        renderLibraryTags();
        renderLibrary();
        updateFilterInfo();
    }

    function showImportView() {
        document.getElementById('set-name-input').value = '';
        document.getElementById('import-json-input').value = '';
        document.getElementById('import-error').textContent = '';
        showView('view-import');
    }

    function saveNewBook() {
        const name = document.getElementById('set-name-input').value.trim();
        const jsonStr = document.getElementById('import-json-input').value;

        if (!name) { document.getElementById('import-error').textContent = 'è¯·è¾“å…¥åç§°'; return; }

        try {
            let data = JSON.parse(jsonStr);
            if (!Array.isArray(data)) throw new Error('å¿…é¡»æ˜¯æ•°ç»„');
            data = addTagsToQuestions(data);
            books.push({ id: Date.now().toString(), name, mistakes: data, solved: [] });
            saveDataToStorage();
            showToast(`å·²åˆ›å»ºï¼ŒåŒ…å« ${data.length} é¢˜`, 'success');
            backToMain();
        } catch (e) { document.getElementById('import-error').textContent = e.message; }
    }

    function openBook(id) {
        currentBookId = id;
        const book = getCurrentBook();
        document.getElementById('book-title-display').textContent = book.name;
        document.getElementById('book-remaining').textContent = book.mistakes.length;
        document.getElementById('book-solved').textContent = (book.solved || []).length;
        document.getElementById('book-starred').textContent = book.mistakes.filter(q => q.starred).length;

        const tags = getAllUsedTags(book.mistakes);
        document.getElementById('book-tags').innerHTML = tags.length > 0
            ? tags.map(t => `<span class="tag ${getTagClass(t)}">${t}</span>`).join('')
            : '<span style="color: var(--text-light);">æš‚æ— </span>';
        showView('view-book');
    }

    function backToBook() { openBook(currentBookId); }

    function getCurrentBook() { return books.find(b => b.id === currentBookId); }

    function deleteBook(id) {
        if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
            books = books.filter(b => b.id !== id);
            saveDataToStorage();
            renderLibrary();
            renderLibraryTags();
        }
    }

    function renameBook(id) {
        const book = books.find(b => b.id === id);
        const newName = prompt('è¾“å…¥æ–°åç§°:', book.name);
        if (newName && newName.trim()) {
            book.name = newName.trim();
            saveDataToStorage();
            renderLibrary();
        }
    }

    function exportBook() {
        const book = getCurrentBook();
        navigator.clipboard.writeText(JSON.stringify(book.mistakes, null, 2)).then(() => showToast('å·²å¤åˆ¶å‰©ä½™é”™é¢˜ JSON', 'success'));
    }

    window.toggleStar = function(index) {
        const book = getCurrentBook();
        book.mistakes[index].starred = !book.mistakes[index].starred;
        saveDataToStorage();
        renderReviewList();
        document.getElementById('book-starred').textContent = book.mistakes.filter(q => q.starred).length;
    };

    window.saveNote = function(index, value) {
        const book = getCurrentBook();
        book.mistakes[index].note = value;
        saveDataToStorage();
    };

    // ========== é”™é¢˜é‡åš ==========
    function startRedo() {
        const book = getCurrentBook();
        if (book.mistakes.length === 0) { alert('æ²¡æœ‰é”™é¢˜'); return; }
        redoMode = 'all';
        redoOriginalCount = book.mistakes.length;
        showView('view-redo');
        renderRedoQuestion();
    }

    function startRedoStarred() {
        const book = getCurrentBook();
        const starred = book.mistakes.filter(q => q.starred);
        if (starred.length === 0) { alert('æ²¡æœ‰æ”¶è—'); return; }
        redoMode = 'starred';
        redoOriginalCount = starred.length;
        showView('view-redo');
        renderRedoQuestion();
    }

    function renderRedoQuestion() {
        const book = getCurrentBook();
        let questions = redoMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
        
        if (questions.length === 0) {
            showToast('å…¨éƒ¨å®Œæˆï¼', 'success');
            backToBook();
            return;
        }
        
        const q = questions[0];
        document.getElementById('redo-count').textContent = questions.length;
        document.getElementById('redo-progress-bar').style.width = ((redoOriginalCount - questions.length) / redoOriginalCount * 100) + '%';
        document.getElementById('redo-submit-btn').classList.remove('hidden');
        document.getElementById('redo-next-btn').classList.add('hidden');
        document.getElementById('redo-feedback').style.display = 'none';
        document.getElementById('redo-feedback').className = 'feedback-box';

        document.getElementById('redo-content').innerHTML = `
            <div id="question-text">${q.question}</div>
            ${(q.tags || []).length > 0 ? `<div class="question-tags">${q.tags.map(t => `<span class="question-tag">${t}</span>`).join('')}</div>` : ''}
            <div id="redo-options" style="margin-top: 20px;">
                ${q.options.map(opt => `
                    <label class="option-label">
                        <input type="radio" name="redo-opt" value="${opt.replace(/"/g, '&quot;')}">
                        <span>${opt}</span>
                    </label>
                `).join('')}
            </div>
        `;

        document.querySelectorAll('#redo-options .option-label').forEach(label => {
            label.querySelector('input').addEventListener('change', () => {
                document.querySelectorAll('#redo-options .option-label').forEach(l => l.classList.remove('selected'));
                label.classList.add('selected');
            });
        });
    }

    function checkRedo() {
        const selected = document.querySelector('input[name="redo-opt"]:checked');
        if (!selected) { alert('è¯·é€‰æ‹©'); return; }
        
        const book = getCurrentBook();
        let questions = redoMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
        const q = questions[0];
        const userVal = selected.value;
        const correctVal = q.answer;
        const fb = document.getElementById('redo-feedback');
        
        document.getElementById('redo-submit-btn').classList.add('hidden');
        document.getElementById('redo-next-btn').classList.remove('hidden');
        fb.style.display = 'block';

        const qIndex = book.mistakes.indexOf(q);
        
        if (userVal === correctVal) {
            fb.classList.add('feedback-correct');
            fb.innerHTML = '<strong>æ­£ç¡®ï¼å·²ç§»é™¤</strong>';
            if (!book.solved) book.solved = [];
            book.solved.push(q);
            book.mistakes.splice(qIndex, 1);
        } else {
            fb.classList.add('feedback-wrong');
            fb.innerHTML = `<strong>é”™è¯¯</strong><br>æ­£ç¡®ç­”æ¡ˆ: ${correctVal}`;
            book.mistakes[qIndex].errorCount = (book.mistakes[qIndex].errorCount || 0) + 1;
            book.mistakes[qIndex].user_wrong_choice = userVal;
            const wrongQ = book.mistakes.splice(qIndex, 1)[0];
            book.mistakes.push(wrongQ);
        }
        saveDataToStorage();
    }
    function nextRedo() { renderRedoQuestion(); }

    // ========== é”™é¢˜å›é¡¾ ==========
    function startReview() {
        const book = getCurrentBook();
        if (book.mistakes.length === 0) { alert('æ²¡æœ‰é”™é¢˜'); return; }
        reviewMode = 'all'; document.getElementById('review-mode-title').textContent = 'å›é¡¾æ¨¡å¼';
        reviewTagFilter = null; renderReviewTags(); renderReviewList(); showView('view-review');
    }
    function startStarredReview() {
        const book = getCurrentBook();
        if (book.mistakes.filter(q => q.starred).length === 0) { alert('æ²¡æœ‰æ”¶è—'); return; }
        reviewMode = 'starred'; document.getElementById('review-mode-title').textContent = 'æ”¶è—å›é¡¾';
        reviewTagFilter = null; renderReviewTags(); renderReviewList(); showView('view-review');
    }
    function renderReviewTags() {
        const book = getCurrentBook();
        let questions = reviewMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
        const allTags = getAllUsedTags(questions);
        document.getElementById('review-tags').innerHTML = allTags.length > 0
            ? allTags.map(t => `<span class="tag ${getTagClass(t)} ${reviewTagFilter === t ? 'active' : ''}" onclick="filterReviewByTag('${t}')">${t}</span>`).join('')
            : '<span style="color: var(--text-light);">æš‚æ— </span>';
    }
    window.filterReviewByTag = function(tag) {
        reviewTagFilter = reviewTagFilter === tag ? null : tag;
        renderReviewTags(); renderReviewList();
        if (reviewTagFilter) {
            const book = getCurrentBook();
            let questions = reviewMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
            const count = questions.filter(q => (q.tags || []).includes(tag)).length;
            document.getElementById('review-filter-info').classList.remove('hidden');
            document.getElementById('review-filter-text').textContent = `${tag} (${count}é¢˜)`;
        } else { document.getElementById('review-filter-info').classList.add('hidden'); }
    };
    function clearReviewTagFilter() {
        reviewTagFilter = null; renderReviewTags(); renderReviewList();
        document.getElementById('review-filter-info').classList.add('hidden');
    }
    function renderReviewList() {
        const book = getCurrentBook();
        const list = document.getElementById('review-list');
        let questions = reviewMode === 'starred' ? book.mistakes.filter(q => q.starred) : book.mistakes;
        if (reviewTagFilter) questions = questions.filter(q => (q.tags || []).includes(reviewTagFilter));
        if (questions.length === 0) { list.innerHTML = '<div class="empty-state"><p>æ²¡æœ‰é¢˜ç›®</p></div>'; return; }
        list.innerHTML = '';
        questions.forEach(q => {
            const qIndex = book.mistakes.indexOf(q);
            const item = document.createElement('div');
            item.className = `review-item ${q.starred ? 'starred' : ''}`;
            item.innerHTML = `
                <button class="star-btn ${q.starred ? 'starred' : ''}" onclick="toggleStar(${qIndex})">â˜…</button>
                ${(q.tags || []).length > 0 ? `<div class="question-tags" style="margin-bottom: 10px;">${q.tags.map(t => `<span class="question-tag">${t}</span>`).join('')}</div>` : ''}
                <div style="font-weight:500; margin-bottom:12px; line-height:1.6; padding-right: 40px;">${q.question} ${q.errorCount > 1 ? `<span class="error-badge">${q.errorCount}æ¬¡</span>` : ''}</div>
                <div style="color:var(--text-light); font-size:0.92em; line-height:1.7;">${q.options.map(o => `<div>- ${o}</div>`).join('')}</div>
                <div style="border-top:1px solid var(--border-color); margin-top:12px; padding-top:12px;">
                    ${q.user_wrong_choice ? `<div style="color:var(--wrong-color); margin-bottom:5px;">æ›¾é€‰: ${q.user_wrong_choice}</div>` : ''}
                    <div style="color:var(--correct-color);">æ­£ç¡®: <strong>${q.answer}</strong></div>
                </div>
                <div class="note-section">${q.note ? `<div class="note-display">${q.note}</div>` : `<textarea class="note-input" placeholder="æ·»åŠ ç¬”è®°..." onchange="saveNote(${qIndex}, this.value)"></textarea>`}</div>
            `;
            list.appendChild(item);
        });
    }

    // ========== åˆ·é¢˜ ==========
    function startQuiz() {
        const input = document.getElementById('quiz-json-input').value;
        const shouldShuffle = document.getElementById('shuffle-checkbox').checked;
        timerEnabled = document.getElementById('timer-checkbox').checked;
        try {
            if (!input.trim()) throw new Error('è¯·è¾“å…¥æ•°æ®');
            quizQuestions = JSON.parse(input);
            if (!Array.isArray(quizQuestions) || quizQuestions.length === 0) throw new Error('å¿…é¡»æ˜¯éç©ºæ•°ç»„');
            if (!quizQuestions[0].question || !quizQuestions[0].answer) throw new Error('æ ¼å¼é”™è¯¯');
            quizQuestions = addTagsToQuestions(quizQuestions);
            if (shouldShuffle) quizQuestions = shuffleArray(quizQuestions);
            lastQuizJSON = input; currentQuizBankId = null;
            quizIndex = 0; quizScore = 0; quizMistakes = [];
            showView('view-quiz'); startTimer(); renderQuizQuestion();
        } catch (e) { document.getElementById('quiz-error').textContent = e.message; }
    }

    function renderQuizQuestion() {
        const q = quizQuestions[quizIndex];
        quizAnswered = false;
        currentQuizFlagged = false;
        document.getElementById('quiz-flag-btn').textContent = 'ğŸš© æ ‡è®°';
        document.getElementById('quiz-flag-btn').style.background = '';
        document.getElementById('quiz-flag-btn').style.color = '';
        document.getElementById('quiz-progress').textContent = `${quizIndex + 1} / ${quizQuestions.length}`;
        document.getElementById('question-text').textContent = q.question;
        document.getElementById('quiz-progress-bar').style.width = (quizIndex / quizQuestions.length * 100) + '%';
        document.getElementById('question-tags-display').innerHTML = (q.tags || []).map(t => `<span class="question-tag">${t}</span>`).join('');
        document.getElementById('quiz-submit-btn').classList.remove('hidden');
        document.getElementById('quiz-next-btn').classList.add('hidden');
        document.getElementById('quiz-feedback').style.display = 'none';
        document.getElementById('quiz-feedback').className = 'feedback-box';
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        q.options.forEach(opt => {
            const label = document.createElement('label');
            label.className = 'option-label';
            label.innerHTML = `<input type="radio" name="quiz-opt" value="${opt.replace(/"/g, '&quot;')}"><span>${opt}</span>`;
            label.querySelector('input').addEventListener('change', () => {
                document.querySelectorAll('#options-container .option-label').forEach(l => l.classList.remove('selected'));
                label.classList.add('selected');
            });
            container.appendChild(label);
        });
    }

    function checkQuizAnswer() {
        if (quizAnswered) return;
        const selected = document.querySelector('input[name="quiz-opt"]:checked');
        if (!selected) { alert('è¯·é€‰æ‹©'); return; }
        quizAnswered = true;
        const userVal = selected.value;
        const correctVal = quizQuestions[quizIndex].answer;
        const fb = document.getElementById('quiz-feedback');
        document.getElementById('quiz-submit-btn').classList.add('hidden');
        document.getElementById('quiz-next-btn').classList.remove('hidden');
        fb.style.display = 'block';
        if (userVal === correctVal) {
            quizScore++; document.getElementById('quiz-score').textContent = quizScore;
            fb.classList.add('feedback-correct'); fb.innerHTML = '<strong>æ­£ç¡®</strong>';
        } else {
            fb.classList.add('feedback-wrong'); fb.innerHTML = `<strong>é”™è¯¯</strong><br>æ­£ç¡®ç­”æ¡ˆ: ${correctVal}`;
            quizMistakes.push({ ...quizQuestions[quizIndex], user_wrong_choice: userVal, errorCount: 1 });
        }
    }

    function nextQuizQuestion() {
        quizIndex++;
        if (quizIndex < quizQuestions.length) renderQuizQuestion();
        else showQuizResults();
    }

    function confirmExitQuiz() { if (confirm('ç¡®å®šé€€å‡ºï¼Ÿ')) { stopTimer(); backToMain(); } }

    function showQuizResults() {
        stopTimer();
        document.getElementById('final-score').textContent = quizScore;
        document.getElementById('final-total').textContent = quizQuestions.length;
        document.getElementById('accuracy-rate').textContent = Math.round(quizScore / quizQuestions.length * 100);
        document.getElementById('total-time').textContent = formatTime(timerSeconds);
        document.getElementById('quiz-progress-bar').style.width = '100%';
        if (quizMistakes.length > 0) {
            document.getElementById('quiz-result-mistakes').classList.remove('hidden');
            document.getElementById('quiz-result-perfect').classList.add('hidden');
            document.getElementById('quiz-mistake-json').value = JSON.stringify(quizMistakes, null, 2);
            autoAddToMistakeBook();
        } else {
            document.getElementById('quiz-result-mistakes').classList.add('hidden');
            document.getElementById('quiz-result-perfect').classList.remove('hidden');
        }
        showView('view-quiz-result');
    }

    function autoAddToMistakeBook() {
        let autoBook = books.find(b => b.name === 'åˆ·é¢˜é”™é¢˜');
        if (!autoBook) { autoBook = { id: 'auto_' + Date.now(), name: 'åˆ·é¢˜é”™é¢˜', mistakes: [], solved: [] }; books.push(autoBook); }
        quizMistakes.forEach(m => {
            const idx = autoBook.mistakes.findIndex(x => x.question === m.question);
            if (idx >= 0) { autoBook.mistakes[idx].errorCount = (autoBook.mistakes[idx].errorCount || 0) + 1; autoBook.mistakes[idx].user_wrong_choice = m.user_wrong_choice; }
            else { autoBook.mistakes.push(m); }
        });
        saveDataToStorage();
    }

    function copyQuizMistakes() { navigator.clipboard.writeText(document.getElementById('quiz-mistake-json').value).then(() => showToast('å·²å¤åˆ¶', 'success')); }

    function restartQuiz() {
        if (currentQuizBankId) { startQuizFromBankId(currentQuizBankId); }
        else { document.getElementById('quiz-json-input').value = lastQuizJSON; backToMain(); startQuiz(); }
    }

    // ç›‘å¬å›è½¦å‘é€ AI æ¶ˆæ¯
    document.getElementById('ai-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendAIMessage();
        }
    });
</script>

</body>
</html>
